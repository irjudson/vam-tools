#!/bin/bash
#
# Pre-push hook to ensure code quality before pushing to GitHub
# This ensures CI will always succeed
#

set -e

# Acquire lock to prevent concurrent pre-push hooks
# This ensures only one push runs tests at a time
LOCK_FILE="/tmp/lumina-pre-push.lock"
LOCK_FD=200

# Cleanup lock on exit
cleanup() {
    flock -u $LOCK_FD 2>/dev/null || true
    rm -f "$LOCK_FILE" 2>/dev/null || true
}
trap cleanup EXIT

# Try to acquire lock (wait if another push is running)
exec {LOCK_FD}>"$LOCK_FILE"
if ! flock -n $LOCK_FD; then
    echo "â³ Another git push is running tests, waiting..."
    if ! flock -w 600 $LOCK_FD; then
        echo "âŒ Could not acquire lock after 10 minutes. Another push may be stuck."
        echo "   Run: rm -f $LOCK_FILE"
        exit 1
    fi
fi

echo "ðŸ” Running pre-push checks..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}âœ— Not in a git repository${NC}"
    exit 1
fi

# Check if virtual environment is activated
if [ -z "$VIRTUAL_ENV" ]; then
    echo -e "${YELLOW}âš  Virtual environment not activated${NC}"
    echo "  Attempting to activate venv..."
    if [ -d "venv" ]; then
        source venv/bin/activate
    else
        echo -e "${RED}âœ— No venv found. Run: python -m venv venv && source venv/bin/activate && pip install -e '.[dev]'${NC}"
        exit 1
    fi
fi

# 1. Check Black formatting
echo -e "${YELLOW}1. Checking code formatting with Black...${NC}"
if ! black --check lumina/ tests/ 2>&1 | grep -q "would be reformatted"; then
    echo -e "${GREEN}  âœ“ Code formatting OK${NC}"
else
    echo -e "${RED}  âœ— Code formatting issues found${NC}"
    echo ""
    echo "  Run: black lumina/ tests/"
    echo "  Then: git add -u && git commit --amend --no-edit"
    exit 1
fi

# 2. Check import sorting with isort
echo ""
echo -e "${YELLOW}2. Checking import sorting with isort...${NC}"
if isort --check-only lumina/ tests/ >/dev/null 2>&1; then
    echo -e "${GREEN}  âœ“ Import sorting OK${NC}"
else
    echo -e "${RED}  âœ— Import sorting issues found${NC}"
    echo ""
    echo "  Run: isort lumina/ tests/"
    echo "  Then: git add -u && git commit --amend --no-edit"
    exit 1
fi

# 3. Lint with flake8
echo ""
echo -e "${YELLOW}3. Linting with flake8...${NC}"
if flake8 lumina/ tests/ 2>/dev/null; then
    echo -e "${GREEN}  âœ“ Linting passed${NC}"
else
    echo -e "${RED}  âœ— Linting issues found${NC}"
    echo ""
    echo "  Run: flake8 lumina/ tests/"
    echo "  Fix the issues before pushing"
    exit 1
fi

# 4. Type check with mypy
echo ""
echo -e "${YELLOW}4. Type checking with mypy...${NC}"
MYPY_BIN="${VIRTUAL_ENV:-venv}/bin/mypy"
if [ ! -f "$MYPY_BIN" ]; then
    MYPY_BIN="venv/bin/mypy"
fi
if "$MYPY_BIN" lumina/ 2>/dev/null; then
    echo -e "${GREEN}  âœ“ Type checking passed${NC}"
else
    echo -e "${RED}  âœ— Type checking issues found${NC}"
    echo ""
    echo "  Run: mypy lumina/"
    echo "  Fix the issues before pushing"
    exit 1
fi

# 5. Run tests
echo ""
echo -e "${YELLOW}5. Running tests...${NC}"
# Use venv pytest explicitly to ensure correct environment
# Skip integration tests (they require Docker services running)
# Run integration tests separately with: pytest -m integration (requires docker-compose services)
PYTEST_BIN="${VIRTUAL_ENV:-venv}/bin/pytest"
if [ ! -f "$PYTEST_BIN" ]; then
    PYTEST_BIN="venv/bin/pytest"
fi
if "$PYTEST_BIN" -n 4 -m "not integration" --tb=short -q; then
    echo -e "${GREEN}  âœ“ All tests passed${NC}"
else
    echo -e "${RED}  âœ— Tests failed${NC}"
    echo ""
    echo "  Fix the failing tests before pushing"
    exit 1
fi

# 6. Optional: Check for common issues
echo ""
echo -e "${YELLOW}6. Checking for common issues...${NC}"

# Check for debugger statements
if git diff --cached --name-only | xargs grep -n "import pdb\|breakpoint()" 2>/dev/null; then
    echo -e "${RED}  âœ— Found debugger statements (pdb/breakpoint)${NC}"
    echo "  Remove them before pushing"
    exit 1
fi

# Check for print statements in production code (excluding CLI modules)
if git diff --cached --name-only | grep -E "lumina/(core|analysis)" | xargs grep -n "print(" 2>/dev/null; then
    echo -e "${YELLOW}  âš  Found print() statements in core code${NC}"
    echo "  Consider using logging instead"
    # Don't exit - just warn
fi

echo -e "${GREEN}  âœ“ No common issues found${NC}"

# 7. Build Docker images (only if Docker-related files changed)
echo ""
echo -e "${YELLOW}7. Checking Docker build...${NC}"

# Check if any Docker-related files changed in this push
DOCKER_FILES_CHANGED=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "(Dockerfile|docker-compose|pyproject.toml|requirements)" || true)

if [ -n "$DOCKER_FILES_CHANGED" ]; then
    echo "  Docker-related files changed, rebuilding..."
    if docker compose build 2>&1; then
        echo -e "${GREEN}  âœ“ Docker images built successfully${NC}"
    else
        echo -e "${RED}  âœ— Docker image build failed${NC}"
        echo ""
        echo "  Run: docker compose build"
        echo "  Fix any build issues before pushing"
        exit 1
    fi
else
    echo -e "${GREEN}  âœ“ No Docker-related changes, skipping build${NC}"
fi

# All checks passed!
echo ""
echo -e "${GREEN}âœ“ All pre-push checks passed!${NC}"
echo -e "${GREEN}  Pushing to GitHub...${NC}"
echo ""

exit 0
