<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAM Tools - Media Catalog Management</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/static/dark-theme.css">
    <link rel="stylesheet" href="/static/styles.css">
    <!-- Leaflet.js for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- noUiSlider for time range -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-container">
                <div class="nav-brand">
                    <h1>VAM Tools</h1>
                </div>

                <!-- Catalog Selector (primary position) -->
                <div class="catalog-selector">
                    <button @click="showCatalogManager = !showCatalogManager" class="catalog-button">
                        <span v-if="currentCatalog" :style="{color: currentCatalog.color}">
                            üìÅ {{ currentCatalog.name }}
                        </span>
                        <span v-else>üìÅ Select Catalog</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>

                    <div v-if="showCatalogManager" class="catalog-dropdown">
                        <div class="catalog-list">
                            <div v-if="catalogs.length === 0" class="empty-catalogs">
                                No catalogs configured. Add one to get started!
                            </div>
                            <div v-for="catalog in catalogs" :key="catalog.id"
                                 :class="['catalog-item', {active: currentCatalog && currentCatalog.id === catalog.id}]">
                                <div class="catalog-color" :style="{background: catalog.color}"></div>
                                <div class="catalog-info" @click="switchCatalog(catalog); showCatalogManager = false">
                                    <div class="catalog-name">{{ catalog.name }}</div>
                                    <div class="catalog-path">{{ catalog.source_directories.map(d => displayPath(d)).join(', ') }}</div>
                                </div>
                                <button
                                    @click.stop="openEditCatalog(catalog)"
                                    class="catalog-edit-btn"
                                    title="Edit catalog"
                                    style="margin-right: 4px;">
                                    ‚úé
                                </button>
                                <button
                                    @click.stop="deleteCatalog(catalog.id)"
                                    class="catalog-delete-btn"
                                    title="Delete catalog configuration">
                                    √ó
                                </button>
                            </div>
                        </div>
                        <div class="catalog-actions">
                            <button @click="showAddCatalogForm = true; showCatalogManager = false" class="btn-primary btn-small">
                                + Add Catalog
                            </button>
                        </div>
                    </div>
                </div>

                <div class="nav-menu">
                    <button
                        @click="setView('browse')"
                        :class="{'active': currentView === 'browse'}"
                        class="nav-button">
                        üè† Home
                    </button>
                    <button
                        @click="setView('jobs')"
                        :class="{'active': currentView === 'jobs'}"
                        class="nav-button">
                        ‚öôÔ∏è Jobs
                        <span v-if="hasActiveJobs" class="badge">{{ activeJobs.length }}</span>
                    </button>
                    <button
                        @click="setView('maptime')"
                        :class="{'active': currentView === 'maptime'}"
                        class="nav-button">
                        üó∫Ô∏è Map/Time
                    </button>
                    <button
                        @click="setView('duplicates')"
                        :class="{'active': currentView === 'duplicates'}"
                        class="nav-button">
                        üîÑ Duplicates
                    </button>

                    <!-- Worker Health Indicator -->
                    <div class="worker-health" :class="'health-' + workerHealth.status" :title="workerHealth.message">
                        <span class="health-dot"></span>
                        <span class="health-text">{{ workerHealth.workers }} worker{{ workerHealth.workers !== 1 ? 's' : '' }}</span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Notifications -->
        <div class="notifications">
            <div v-for="notification in notifications" :key="notification.id"
                 :class="['notification', `notification-${notification.type}`]">
                {{ notification.message }}
                <button @click="removeNotification(notification.id)" class="notification-close">√ó</button>
            </div>
        </div>

        <!-- Main Browse View (default home page) -->
        <div v-if="currentView === 'browse'" class="view-container">
            <div class="content-wrapper">
                <!-- Catalog Statistics Panel (Collapsible) -->
                <div v-if="currentCatalog && catalogStats" class="catalog-stats-panel">
                    <div class="stats-panel-header" @click="statsExpanded = !statsExpanded">
                        <h3>
                            <span class="collapse-icon">{{ statsExpanded ? '‚ñº' : '‚ñ∂' }}</span>
                            Catalog Statistics
                        </h3>
                        <div class="stats-summary" v-if="!statsExpanded">
                            {{ formatNumber(catalogStats.statistics.total_files) }} files ‚Ä¢ {{ catalogStats.statistics.total_gb }} GB
                        </div>
                    </div>
                    <div v-show="statsExpanded" class="stats-panel-content">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">{{ formatNumber(catalogStats.statistics.total_files) }}</div>
                                <div class="stat-label">Total Files</div>
                                <div class="stat-detail">
                                    {{ formatNumber(catalogStats.statistics.images) }} images,
                                    {{ formatNumber(catalogStats.statistics.videos) }} videos
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ catalogStats.statistics.total_gb }} GB</div>
                                <div class="stat-label">Total Size</div>
                                <div class="stat-detail">{{ formatBytes(catalogStats.statistics.total_bytes) }}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ catalogStats.source_directories.length }}</div>
                                <div class="stat-label">Source Directories</div>
                                <div class="stat-detail" :title="catalogStats.source_directories.join('\n')">
                                    {{ catalogStats.source_directories[0] ? displayPath(catalogStats.source_directories[0]) : 'None' }}
                                    <span v-if="catalogStats.source_directories.length > 1">+{{ catalogStats.source_directories.length - 1 }} more</span>
                                </div>
                            </div>
                            <div class="stat-card" v-if="catalogStats.statistics.date_range.earliest && isValidDateRange(catalogStats.statistics.date_range)">
                                <div class="stat-value">{{ getYear(catalogStats.statistics.date_range.earliest) }} - {{ getYear(catalogStats.statistics.date_range.latest) }}</div>
                                <div class="stat-label">Date Range</div>
                                <div class="stat-detail">Media dates in catalog</div>
                            </div>
                        </div>

                        <!-- Recent Jobs for this catalog -->
                        <div v-if="catalogStats.recent_jobs && catalogStats.recent_jobs.length > 0" class="recent-jobs-summary">
                            <h4>Recent Jobs</h4>
                            <div class="recent-jobs-list">
                                <div v-for="job in catalogStats.recent_jobs.slice(0, 3)" :key="job.id" class="recent-job-item">
                                    <span :class="['status-dot', 'status-' + job.status.toLowerCase()]"></span>
                                    <span class="job-type">{{ job.job_type }}</span>
                                    <span class="job-date">{{ formatDate(job.created_at) }}</span>
                                    <span v-if="job.result && job.result.files_added" class="job-result">
                                        +{{ formatNumber(job.result.files_added) }} files
                                    </span>
                                </div>
                            </div>
                            <button @click="setView('jobs')" class="btn-link">View all jobs ‚Üí</button>
                        </div>
                    </div>
                </div>

                <!-- Actions Panel -->
                <div v-if="currentCatalog" class="actions-panel">
                    <div class="actions-grid">
                        <button @click="startScan" class="action-btn" :disabled="!currentCatalog">
                            <span class="action-icon">üìÇ</span>
                            <div class="action-text">
                                <div class="action-title">Find Files</div>
                                <div class="action-desc">Scan directories for media</div>
                            </div>
                        </button>
                        <button @click="startAutoTag" class="action-btn" :disabled="!currentCatalog">
                            <span class="action-icon">üè∑Ô∏è</span>
                            <div class="action-text">
                                <div class="action-title">Auto-Tag</div>
                                <div class="action-desc">AI-powered image tagging</div>
                            </div>
                        </button>
                        <button @click="startFindDuplicates" class="action-btn" :disabled="!currentCatalog">
                            <span class="action-icon">üîç</span>
                            <div class="action-text">
                                <div class="action-title">Find Duplicates</div>
                                <div class="action-desc">Detect duplicate files</div>
                            </div>
                        </button>
                        <button @click="startBurstDetection" class="action-btn" :disabled="!currentCatalog">
                            <span class="action-icon">üì∏</span>
                            <div class="action-text">
                                <div class="action-title">Detect Bursts</div>
                                <div class="action-desc">Find burst sequences</div>
                            </div>
                        </button>
                        <button @click="setView('review')" class="action-btn" :disabled="!currentCatalog || reviewQueueStats.total_needing_review === 0">
                            <span class="action-icon">üìù</span>
                            <div class="action-text">
                                <div class="action-title">Review Duplicates</div>
                                <div class="action-desc" v-if="reviewQueueStats.total_needing_review > 0">{{ reviewQueueStats.total_needing_review }} groups to review</div>
                                <div class="action-desc" v-else>No duplicates to review</div>
                            </div>
                        </button>
                        <button @click="startFindFaces" class="action-btn" :disabled="!currentCatalog" style="opacity: 0.5;">
                            <span class="action-icon">üë§</span>
                            <div class="action-text">
                                <div class="action-title">Find Faces</div>
                                <div class="action-desc">Coming soon</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Search and Filter Panel -->
                <div v-if="currentCatalog" class="search-filter-panel">
                    <!-- Search Bar -->
                    <div class="search-bar-container">
                        <input
                            type="text"
                            v-model="filters.search"
                            @input="onSearchInput"
                            placeholder="Search by filename or path..."
                            class="search-input"
                        />
                        <button v-if="filters.search" @click="filters.search = ''; loadImages(true)" class="search-clear-btn" title="Clear search">
                            &times;
                        </button>
                    </div>

                    <!-- Filter Toggle and Sort -->
                    <div class="filter-sort-row">
                        <button @click="filtersExpanded = !filtersExpanded" class="filter-toggle-btn" :class="{ 'has-filters': hasActiveFilters() }">
                            <span class="filter-icon">üîç</span>
                            <span>Filters</span>
                            <span v-if="hasActiveFilters()" class="filter-badge">Active</span>
                            <span class="collapse-icon">{{ filtersExpanded ? '‚ñº' : '‚ñ∂' }}</span>
                        </button>

                        <!-- Sort Controls -->
                        <div class="sort-controls">
                            <label>Sort:</label>
                            <select v-model="sortBy" @change="onSortChange" class="sort-select">
                                <option value="date">Date</option>
                                <option value="filename">Filename</option>
                                <option value="size">Size</option>
                                <option value="created_at">Added</option>
                            </select>
                            <button @click="sortOrder = sortOrder === 'desc' ? 'asc' : 'desc'; onSortChange()" class="sort-order-btn" :title="sortOrder === 'desc' ? 'Descending' : 'Ascending'">
                                {{ sortOrder === 'desc' ? '‚Üì' : '‚Üë' }}
                            </button>
                        </div>

                        <!-- Thumbnail Size Selector -->
                        <div class="size-selector-group">
                            <label>Size:</label>
                            <select v-model="thumbnailSize" class="size-selector">
                                <option value="small">Small</option>
                                <option value="medium">Medium</option>
                                <option value="large">Large</option>
                            </select>
                        </div>
                    </div>

                    <!-- Expanded Filters -->
                    <div v-show="filtersExpanded" class="filters-panel">
                        <div class="filters-grid">
                            <!-- File Type -->
                            <div class="filter-group">
                                <label>File Type</label>
                                <select v-model="filters.file_type" @change="applyFilters">
                                    <option value="">All Types</option>
                                    <option value="image">Images</option>
                                    <option value="video">Videos</option>
                                </select>
                            </div>

                            <!-- Camera Make -->
                            <div class="filter-group">
                                <label>Camera Make</label>
                                <select v-model="filters.camera_make" @change="applyFilters">
                                    <option value="">All Makes</option>
                                    <option v-for="make in (filterOptions?.camera_makes || [])" :key="make" :value="make">{{ make }}</option>
                                </select>
                            </div>

                            <!-- Camera Model -->
                            <div class="filter-group">
                                <label>Camera Model</label>
                                <select v-model="filters.camera_model" @change="applyFilters">
                                    <option value="">All Models</option>
                                    <option v-for="model in (filterOptions?.camera_models || [])" :key="model" :value="model">{{ model }}</option>
                                </select>
                            </div>

                            <!-- Lens -->
                            <div class="filter-group">
                                <label>Lens</label>
                                <select v-model="filters.lens" @change="applyFilters">
                                    <option value="">All Lenses</option>
                                    <option v-for="lens in (filterOptions?.lenses || [])" :key="lens" :value="lens">{{ lens }}</option>
                                </select>
                            </div>

                            <!-- Focal Length -->
                            <div class="filter-group">
                                <label>Focal Length</label>
                                <select v-model="filters.focal_length" @change="applyFilters">
                                    <option value="">All</option>
                                    <option v-for="fl in (filterOptions?.focal_lengths || [])" :key="fl" :value="fl">{{ fl }}mm</option>
                                </select>
                            </div>

                            <!-- F-Stop / Aperture -->
                            <div class="filter-group">
                                <label>Aperture</label>
                                <select v-model="filters.f_stop" @change="applyFilters">
                                    <option value="">All</option>
                                    <option v-for="fstop in (filterOptions?.f_stops || [])" :key="fstop" :value="fstop">f/{{ fstop }}</option>
                                </select>
                            </div>

                            <!-- GPS Filter -->
                            <div class="filter-group">
                                <label>Location</label>
                                <select v-model="filters.has_gps" @change="applyFilters">
                                    <option :value="null">All</option>
                                    <option :value="true">With GPS</option>
                                    <option :value="false">Without GPS</option>
                                </select>
                            </div>

                            <!-- Date Range -->
                            <div class="filter-group filter-date-range">
                                <label>Date Range</label>
                                <div class="date-inputs">
                                    <input type="date" v-model="filters.date_from" @change="applyFilters" placeholder="From" />
                                    <span>to</span>
                                    <input type="date" v-model="filters.date_to" @change="applyFilters" placeholder="To" />
                                </div>
                            </div>

                            <!-- Has Tags Filter -->
                            <div class="filter-group">
                                <label>Tagged</label>
                                <select v-model="filters.has_tags" @change="applyFilters">
                                    <option :value="null">All Images</option>
                                    <option :value="true">With Tags</option>
                                    <option :value="false">Without Tags</option>
                                </select>
                            </div>
                        </div>

                        <!-- Semantic Search Section -->
                        <div v-if="currentCatalog" class="semantic-search-section">
                            <div class="search-section-header">
                                <label>Semantic Search</label>
                                <span v-if="searchMode" class="search-mode-indicator">Search mode active</span>
                            </div>
                            <div class="search-input-wrapper">
                                <input
                                    type="text"
                                    v-model="semanticSearchQuery"
                                    @keyup.enter="performSemanticSearch"
                                    placeholder="e.g., sunset over mountains"
                                    class="semantic-search-input"
                                >
                                <button
                                    @click="performSemanticSearch"
                                    :disabled="!semanticSearchQuery || isSearching"
                                    class="search-btn"
                                >
                                    {{ isSearching ? 'Searching...' : 'Search' }}
                                </button>
                            </div>
                            <div v-if="searchResults.length > 0" class="search-results-info">
                                Found {{ searchResults.length }} results
                                <button @click="clearSearch" class="clear-search-btn">Clear</button>
                            </div>
                        </div>

                        <!-- Tags Filter Section -->
                        <div v-if="availableTags.length > 0" class="tags-filter-section">
                            <div class="tags-filter-header">
                                <label>Filter by Tags</label>
                                <div class="tag-match-toggle">
                                    <label>
                                        <input type="radio" v-model="filters.tag_match" value="any" @change="applyFilters" />
                                        Any
                                    </label>
                                    <label>
                                        <input type="radio" v-model="filters.tag_match" value="all" @change="applyFilters" />
                                        All
                                    </label>
                                </div>
                            </div>
                            <div class="tags-filter-list">
                                <button
                                    v-for="tag in availableTags.slice(0, 30)"
                                    :key="tag.id"
                                    @click="toggleTagFilter(tag.name)"
                                    :class="['tag-filter-btn', { active: isTagSelected(tag.name) }]"
                                    :title="tag.count + ' images'">
                                    {{ tag.name }}
                                    <span class="tag-count">{{ tag.count }}</span>
                                </button>
                                <span v-if="availableTags.length > 30" class="more-tags">
                                    +{{ availableTags.length - 30 }} more tags
                                </span>
                            </div>
                        </div>

                        <!-- Clear Filters Button -->
                        <div class="filter-actions">
                            <button v-if="hasActiveFilters()" @click="clearFilters" class="btn-secondary btn-small">
                                Clear All Filters
                            </button>
                        </div>
                    </div>
                </div>

                <div class="browse-header">
                    <h2 v-if="currentCatalog">
                        <span v-if="images.length < imagesTotal">
                            Showing {{ formatNumber(images.length) }} of {{ formatNumber(imagesTotal) }} {{ imagesTotal === 1 ? 'image' : 'images' }}
                        </span>
                        <span v-else>
                            {{ formatNumber(imagesTotal) }} {{ imagesTotal === 1 ? 'image' : 'images' }}
                        </span>
                        <span v-if="hasActiveFilters()" class="filtered-label">(filtered)</span>
                    </h2>
                    <h2 v-else>Select a Catalog</h2>
                </div>

                <!-- Loading State -->
                <div v-if="imagesLoading && images.length === 0" class="text-center p-lg">
                    <div class="spinner"></div>
                    <p class="text-secondary mt-md">Loading images...</p>
                </div>

                <!-- No Catalog Selected -->
                <div v-else-if="!currentCatalog" class="text-center p-lg">
                    <p class="text-secondary">Please select a catalog to browse images</p>
                </div>

                <!-- Empty State -->
                <div v-else-if="images.length === 0 && !imagesLoading" class="text-center p-lg">
                    <p class="text-secondary">No images found in this catalog</p>
                    <button @click="loadImages(true)" class="btn mt-md">Refresh</button>
                </div>

                <!-- Image Grid -->
                <div v-else :class="['image-grid-container', 'size-' + thumbnailSize]">
                    <div
                        v-for="(image, index) in images"
                        :key="image.id"
                        class="thumbnail"
                        :class="{'selected': isImageSelected(image.id)}"
                        @click="openLightbox(index)"
                    >
                        <img
                            :src="getThumbnailUrl(image)"
                            :alt="image.source_path"
                            loading="lazy"
                        />
                        <!-- Burst indicator -->
                        <div v-if="image.burst_id && getBurstInfo(image)" class="burst-indicator" @click.stop="viewBurst(image.burst_id)">
                            <span class="burst-icon">üì∑</span>
                            <span class="burst-count">{{ getBurstInfo(image).image_count }}</span>
                        </div>
                        <div class="thumbnail-overlay">
                            <div class="text-sm">{{ image.source_path.split('/').pop() }}</div>
                        </div>
                        <!-- Tags display on thumbnail -->
                        <div v-if="image.tags && image.tags.length > 0" class="thumbnail-tags">
                            <span v-for="tag in image.tags.slice(0, 3)" :key="tag.name" class="thumbnail-tag">
                                {{ tag.name }}
                            </span>
                            <span v-if="image.tags.length > 3" class="thumbnail-tag-more">
                                +{{ image.tags.length - 3 }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Loading More Indicator (inline at bottom) -->
                <div v-if="imagesLoading && images.length > 0" class="loading-more">
                    <div class="spinner"></div>
                    <span>Loading more images...</span>
                </div>

                <!-- End of images indicator -->
                <div v-else-if="images.length > 0 && !hasMoreImages" class="end-of-images">
                    All {{ formatNumber(imagesTotal) }} images loaded
                </div>

                <!-- Manual load more (fallback if infinite scroll is slow) -->
                <div v-else-if="hasMoreImages && !imagesLoading" class="load-more-container">
                    <button @click="loadImages(false)" class="btn-secondary">
                        Load More ({{ formatNumber(imagesTotal - images.length) }} remaining)
                    </button>
                </div>
            </div>
        </div>

        <!-- Jobs View -->
        <div v-if="currentView === 'jobs'" class="view-container">
            <div class="content-wrapper">
                <h2>Job Management</h2>

                <!-- Active Jobs -->
                <section v-if="activeJobs.length > 0" class="active-jobs-section">
                    <h3>Active Jobs ({{ activeJobs.length }})</h3>
                    <div class="jobs-grid">
                        <div v-for="job in activeJobs" :key="job.id" class="job-card active">
                            <div class="job-header">
                                <strong>{{ job.name || 'Job' }}</strong>
                                <span :class="['status-badge', getJobStatusClass(job.status)]">
                                    {{ formatJobStatus(job.status) }}
                                </span>
                            </div>
                            <div class="job-id">ID: {{ job.id }}</div>
                            <!-- Stats display for all jobs -->
                            <div v-if="(job.progress && Object.keys(job.progress).length > 0) || (job.result && Object.keys(job.result).length > 0)" class="job-stats-display">
                                <div class="table-result-stats">
                                    <span v-if="'added' in (job.progress || {}) || 'added' in (job.result || {})" class="result-badge badge-success">
                                        +{{ job.progress?.added ?? job.result?.added ?? 0 }} added
                                    </span>
                                    <span v-if="'skipped' in (job.progress || {}) || 'skipped' in (job.result || {})" class="result-badge badge-muted">
                                        {{ job.progress?.skipped ?? job.result?.skipped ?? 0 }} skipped
                                    </span>
                                    <span v-if="'updated' in (job.progress || {}) || 'updated' in (job.result || {})" class="result-badge badge-warning">
                                        {{ job.progress?.updated ?? job.result?.updated ?? 0 }} updated
                                    </span>
                                    <span v-if="('errors' in (job.progress || {}) && job.progress.errors > 0) || ('errors' in (job.result || {}) && job.result.errors > 0)" class="result-badge badge-danger">
                                        {{ job.progress?.errors ?? job.result?.errors ?? 0 }} errors
                                    </span>
                                    <span v-if="'processed' in (job.progress || {}) || 'processed' in (job.result || {})" class="result-badge badge-info">
                                        {{ job.progress?.processed ?? job.result?.processed ?? 0 }} processed
                                    </span>
                                    <span v-if="'files_added' in (job.progress || {}) || 'files_added' in (job.result || {})" class="result-badge badge-success">
                                        +{{ job.progress?.files_added ?? job.result?.files_added ?? 0 }} files
                                    </span>
                                    <span v-if="'organized' in (job.progress || {}) || 'organized' in (job.result || {})" class="result-badge badge-success">
                                        {{ job.progress?.organized ?? job.result?.organized ?? 0 }} organized
                                    </span>
                                    <span v-if="'generated' in (job.progress || {}) || 'generated' in (job.result || {})" class="result-badge badge-success">
                                        {{ job.progress?.generated ?? job.result?.generated ?? 0 }} generated
                                    </span>
                                </div>
                            </div>
                            <div v-if="job.error" class="job-error-summary">
                                <div class="error-label">‚úó Error</div>
                                <div class="error-text">{{ job.error }}</div>
                            </div>
                            <div class="job-actions">
                                <button v-if="job.status === 'PROGRESS' || job.status === 'PENDING'"
                                        @click="cancelJob(job.id)" class="btn-secondary btn-small" title="Stop job gracefully">
                                    Cancel
                                </button>
                                <button v-if="job.status === 'PROGRESS' || job.status === 'PENDING'"
                                        @click="killJob(job.id)" class="btn-danger btn-small" title="Force kill stuck job">
                                    Force Kill
                                </button>
                                <button @click="rerunJob(job.id)" class="btn-primary btn-small" title="Rerun job with same parameters">
                                    üîÑ Rerun
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- All Jobs -->
                <section class="all-jobs-section">
                    <div class="job-history-header-row">
                        <h3>Job History</h3>
                        <button v-if="completedJobs.length > 0"
                                @click="toggleAllArchived"
                                class="archive-all-btn">
                            {{ allJobsArchived ? 'Expand All' : 'Collapse All' }}
                        </button>
                    </div>
                    <div class="jobs-list">
                        <div v-if="jobs.length > 0">
                            <div v-for="job in jobs" :key="job.id"
                                 class="job-history-card"
                                 :class="['job-' + job.status.toLowerCase(), { 'archived': isJobArchived(job.id) }]">
                                <div class="job-history-header">
                                    <div class="job-history-title">
                                        <button v-if="job.status === 'SUCCESS' || job.status === 'FAILURE'"
                                                @click="toggleJobArchived(job.id)"
                                                class="archive-toggle"
                                                :title="isJobArchived(job.id) ? 'Expand' : 'Collapse'">
                                            {{ isJobArchived(job.id) ? '‚ñ∂' : '‚ñº' }}
                                        </button>
                                        <span class="job-type-icon">{{ getJobIcon(job.name) }}</span>
                                        <strong>{{ job.name || 'Job' }}</strong>
                                        <span :class="['status-badge', getJobStatusClass(job.status)]">
                                            {{ formatJobStatus(job.status) }}
                                        </span>
                                    </div>
                                    <div class="job-history-meta">
                                        <span class="job-id" title="Job ID">{{ job.id.substring(0, 8) }}...</span>
                                        <span class="job-date">{{ formatDate(job.started) }}</span>
                                    </div>
                                </div>

                                <!-- Timing Info for completed jobs -->
                                <div v-if="(job.status === 'SUCCESS' || job.status === 'FAILURE') && !isJobArchived(job.id)" class="job-timing">
                                    <span class="timing-item" v-if="job.started">
                                        <span class="timing-icon">üïê</span>
                                        <span class="timing-value">{{ formatDate(job.started) }}</span>
                                    </span>
                                    <span class="timing-item" v-if="job.durationSeconds">
                                        <span class="timing-icon">‚è±Ô∏è</span>
                                        <span class="timing-value">{{ formatDuration(job.durationSeconds) }}</span>
                                    </span>
                                </div>

                                <!-- Result Summary -->
                                <div v-if="job.result && Object.keys(job.result).length > 0 && !isJobArchived(job.id)" class="job-result-summary">
                                    <!-- Auto-tag job results -->
                                    <div v-if="job.result.images_tagged !== undefined" class="job-stats-row">
                                        <span class="stat-item stat-success">
                                            <strong>üè∑Ô∏è {{ formatNumber(job.result.images_tagged) }}</strong> tagged
                                        </span>
                                        <span class="stat-item">
                                            of {{ formatNumber(job.result.total_images) }} images
                                        </span>
                                        <span v-if="job.result.unique_tags_applied" class="stat-item">
                                            {{ formatNumber(job.result.unique_tags_applied) }} unique tags
                                        </span>
                                        <span v-if="job.result.backend" class="stat-item stat-muted">
                                            {{ job.result.backend }}
                                        </span>
                                    </div>

                                    <!-- Top tags breakdown for auto-tag jobs -->
                                    <div v-if="job.result.top_tags && job.result.top_tags.length > 0" class="job-stats-detail">
                                        <details>
                                            <summary>Top Tags</summary>
                                            <div class="top-tags-breakdown">
                                                <span v-for="[tag, count] in job.result.top_tags.slice(0, 8)" :key="tag" class="tag-stat">
                                                    {{ tag }}: {{ count }}
                                                </span>
                                            </div>
                                        </details>
                                    </div>

                                    <!-- Scan job results - New comprehensive stats format -->
                                    <div v-else-if="job.result.files_discovered" class="job-stats-row">
                                        <span class="stat-item">
                                            <strong>{{ formatNumber(job.result.files_discovered) }}</strong> discovered
                                        </span>
                                        <span class="stat-item stat-success">
                                            <strong>+{{ formatNumber(job.result.files_added) }}</strong> added
                                        </span>
                                        <span v-if="job.result.total_skipped > 0" class="stat-item stat-muted">
                                            {{ formatNumber(job.result.total_skipped) }} skipped
                                        </span>
                                        <span v-if="job.result.total_errors > 0" class="stat-item stat-error">
                                            {{ formatNumber(job.result.total_errors) }} errors
                                        </span>
                                    </div>

                                    <!-- Skip reasons breakdown -->
                                    <div v-if="job.result.skip_reasons" class="job-stats-detail">
                                        <details>
                                            <summary>Skip Breakdown</summary>
                                            <div class="skip-breakdown">
                                                <span v-if="job.result.skip_reasons.already_in_catalog">Already in catalog: {{ formatNumber(job.result.skip_reasons.already_in_catalog) }}</span>
                                                <span v-if="job.result.skip_reasons.unsupported_format">Unsupported format: {{ formatNumber(job.result.skip_reasons.unsupported_format) }}</span>
                                                <span v-if="job.result.skip_reasons.hidden_file">Hidden files: {{ formatNumber(job.result.skip_reasons.hidden_file) }}</span>
                                                <span v-if="job.result.skip_reasons.synology_metadata">Synology metadata: {{ formatNumber(job.result.skip_reasons.synology_metadata) }}</span>
                                                <span v-if="job.result.skip_reasons.not_accessible">Not accessible: {{ formatNumber(job.result.skip_reasons.not_accessible) }}</span>
                                            </div>
                                        </details>
                                    </div>

                                    <!-- File types and size -->
                                    <div v-if="job.result.file_types || job.result.size_stats || job.result.duration_seconds" class="job-stats-row secondary">
                                        <span v-if="job.result.file_types" class="stat-item">
                                            {{ formatNumber(job.result.file_types.images) }} images, {{ formatNumber(job.result.file_types.videos) }} videos
                                        </span>
                                        <span v-if="job.result.size_stats" class="stat-item">
                                            {{ job.result.size_stats.total_gb }} GB processed
                                        </span>
                                        <span v-if="job.result.duration_seconds" class="stat-item">
                                            {{ formatDuration(job.result.duration_seconds) }}
                                            <small v-if="job.result.files_per_second">({{ job.result.files_per_second.toFixed(1) }} files/sec)</small>
                                        </span>
                                    </div>

                                    <!-- Legacy format fallback -->
                                    <div v-else-if="!job.result.files_discovered && !job.result.images_tagged" class="job-stats-row">
                                        <span v-if="'files_added' in job.result" class="stat-item stat-success">
                                            +{{ formatNumber(job.result.files_added) }} files
                                        </span>
                                        <span v-if="'processed' in job.result" class="stat-item">
                                            {{ formatNumber(job.result.processed) }} processed
                                        </span>
                                    </div>
                                </div>

                                <!-- Progress for active jobs -->
                                <div v-else-if="job.progress && Object.keys(job.progress).length > 0" class="job-progress-summary">
                                    <div class="job-stats-row">
                                        <span v-if="job.progress.added" class="stat-item stat-success">+{{ formatNumber(job.progress.added) }} added</span>
                                        <span v-if="job.progress.processed" class="stat-item">{{ formatNumber(job.progress.processed) }} processed</span>
                                        <span v-if="job.progress.message" class="stat-item">{{ job.progress.message }}</span>
                                    </div>
                                </div>

                                <!-- Error display -->
                                <div v-if="job.error && !isJobArchived(job.id)" class="job-error-display">
                                    <span class="error-icon">‚ö†Ô∏è</span> {{ job.error }}
                                </div>

                                <!-- Actions -->
                                <div v-if="!isJobArchived(job.id)" class="job-history-actions">
                                    <button v-if="job.status === 'PROGRESS' || job.status === 'PENDING'"
                                        @click="cancelJob(job.id)"
                                        class="btn-secondary btn-small"
                                        title="Cancel job">
                                        Cancel
                                    </button>
                                    <button v-if="job.status === 'PROGRESS' || job.status === 'PENDING'"
                                        @click="killJob(job.id)"
                                        class="btn-danger btn-small"
                                        title="Force kill">
                                        Kill
                                    </button>
                                    <button v-if="job.status === 'SUCCESS' || job.status === 'FAILURE'"
                                        @click="showJobDetails(job)"
                                        class="btn-secondary btn-small"
                                        title="View full details">
                                        Details
                                    </button>
                                    <button
                                        @click="deleteJob(job.id)"
                                        class="btn-danger btn-small"
                                        title="Delete from history">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div v-else class="empty-state">
                            No jobs yet. Start by using the Quick Actions on the Dashboard!
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Review Queue View -->
        <div v-if="currentView === 'review'" class="view-container">
            <div class="content-wrapper">
                <h2>Review Queue</h2>

                <section class="review-stats">
                    <h3>Overview</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Total Items</h4>
                            <div class="stat-value">{{ reviewQueueStats.total_needing_review }}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Date Conflicts</h4>
                            <div class="stat-value">{{ reviewQueueStats.date_conflicts }}</div>
                        </div>
                        <div class="stat-card">
                            <h4>No Date</h4>
                            <div class="stat-value">{{ reviewQueueStats.no_date }}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Suspicious Dates</h4>
                            <div class="stat-value">{{ reviewQueueStats.suspicious_dates }}</div>
                        </div>
                    </div>
                </section>

                <section class="review-items">
                    <h3>Items Needing Review</h3>
                    <div v-if="reviewQueue.length > 0" class="review-list">
                        <div v-for="item in reviewQueue" :key="item.id" class="review-card">
                            <div class="review-thumbnail">
                                <img :src="item.thumbnail_path ? `/api/images/${item.id}/thumbnail` : `/api/preview/${encodeURIComponent(item.source_path)}`" 
                                     :alt="item.source_path"
                                     loading="lazy"
                                />
                            </div>
                            <div class="review-info">
                                <div class="review-path">{{ item.source_path }}</div>
                                <div class="review-reason">Reason: {{ item.type.replace('_', ' ') }}</div>
                                <div v-if="item.current_date" class="review-current-date">
                                    Current Date: {{ formatDate(item.current_date) }}
                                </div>
                                <div v-if="item.confidence" class="review-confidence">
                                    Confidence: {{ item.confidence }}%
                                </div>
                                <div class="review-actions">
                                    <button @click="resolveReviewItem(item.id)" class="btn-primary btn-small">
                                        Resolve
                                    </button>
                                    <button @click="skipReviewItem(item.id)" class="btn-secondary btn-small">
                                        Skip
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else class="empty-state">
                        No items currently in the review queue.
                    </div>
                </section>
            </div>
        </div>

        <!-- Map/Time View -->
        <div v-if="currentView === 'maptime'" class="view-container">
            <div class="content-wrapper maptime-wrapper">
                <div v-if="!currentCatalog" class="text-center p-lg">
                    <p class="text-secondary">Please select a catalog to view on the map</p>
                </div>

                <div v-else class="maptime-container">
                    <!-- Map Container -->
                    <div class="map-section">
                        <div id="photo-map" class="photo-map"></div>
                        <div class="map-controls">
                            <div class="map-stats">
                                <span class="stat">{{ formatNumber(mapStats.displayed) }} clusters</span>
                                <span class="stat">{{ formatNumber(mapStats.totalPhotos) }} photos with GPS</span>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline Section -->
                    <div class="timeline-section">
                        <div class="timeline-header">
                            <h3>Time Range</h3>
                            <span class="date-display">
                                {{ formatDateShort(timelineRange.from) }} - {{ formatDateShort(timelineRange.to) }}
                            </span>
                            <span class="timeline-totals" v-if="timelineData">
                                {{ formatNumber(timelineData.total_with_gps) }} GPS / {{ formatNumber(timelineData.total_images) }} total
                            </span>
                        </div>
                        <div class="timeline-histogram" ref="histogramContainer">
                            <canvas ref="histogramCanvas"></canvas>
                        </div>
                        <div id="timeline-slider" class="timeline-slider"></div>
                    </div>

                    <!-- Cluster Preview Panel -->
                    <div v-if="selectedCluster" class="cluster-preview-panel">
                        <div class="panel-header">
                            <h3>{{ formatNumber(selectedCluster.count) }} Photos</h3>
                            <button @click="selectedCluster = null" class="close-btn">√ó</button>
                        </div>
                        <div class="cluster-thumbnails">
                            <div v-for="image in clusterImages" :key="image.id" class="cluster-thumb"
                                 @click="openClusterLightbox(image)">
                                <img :src="getClusterThumbnailUrl(image)" :alt="image.source_path" loading="lazy" />
                            </div>
                        </div>
                        <div v-if="clusterImagesLoading" class="cluster-loading">
                            <div class="spinner"></div>
                        </div>
                        <div v-else-if="clusterImages.length < selectedCluster.count" class="load-more">
                            <button @click="loadMoreClusterImages" class="btn-secondary btn-small">
                                Load more ({{ selectedCluster.count - clusterImages.length }} remaining)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Duplicates View -->
        <div v-if="currentView === 'duplicates'" class="view-container">
            <div class="content-wrapper">
                <div v-if="!currentCatalog" class="text-center p-lg">
                    <p class="text-secondary">Please select a catalog to view duplicates</p>
                </div>

                <div v-else>
                    <div class="duplicates-header">
                        <h2>Duplicate Detection</h2>
                        <button @click="startFindDuplicates" class="btn-primary">
                            üîç Find Duplicates
                        </button>
                    </div>

                    <!-- Statistics Panel -->
                    <div v-if="duplicatesStats" class="stats-grid mb-lg">
                        <div class="stat-card">
                            <div class="stat-value">{{ formatNumber(duplicatesStats.total_groups || 0) }}</div>
                            <div class="stat-label">Duplicate Groups</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ formatNumber(duplicatesStats.exact_groups || 0) }}</div>
                            <div class="stat-label">Exact Matches</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ formatNumber(duplicatesStats.perceptual_groups || 0) }}</div>
                            <div class="stat-label">Similar Images</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ duplicatesStats.potential_space_savings_gb || 0 }} GB</div>
                            <div class="stat-label">Potential Savings</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="filter-bar mb-md">
                        <div class="filter-group">
                            <label>Type:</label>
                            <select v-model="duplicatesFilter.similarity_type" @change="applyDuplicatesFilter">
                                <option :value="null">All Types</option>
                                <option value="exact">Exact Matches</option>
                                <option value="perceptual">Similar Images</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Status:</label>
                            <select v-model="duplicatesFilter.reviewed" @change="applyDuplicatesFilter">
                                <option :value="null">All</option>
                                <option :value="false">Needs Review</option>
                                <option :value="true">Reviewed</option>
                            </select>
                        </div>
                        <button v-if="duplicatesFilter.similarity_type || duplicatesFilter.reviewed !== null"
                                @click="clearDuplicatesFilter"
                                class="btn-secondary btn-small">
                            Clear Filters
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div v-if="duplicatesLoading && duplicateGroups.length === 0" class="text-center p-lg">
                        <div class="spinner"></div>
                        <p class="text-secondary mt-md">Loading duplicate groups...</p>
                    </div>

                    <!-- Empty State -->
                    <div v-else-if="duplicateGroups.length === 0 && !duplicatesLoading" class="text-center p-lg">
                        <p class="text-secondary">No duplicates found. Run "Find Duplicates" to detect duplicate images.</p>
                    </div>

                    <!-- Duplicate Groups Grid -->
                    <div v-else class="duplicates-grid">
                        <div v-for="group in duplicateGroups" :key="group.id"
                             class="duplicate-group-card"
                             :class="{ 'reviewed': group.reviewed }"
                             @click="selectDuplicateGroup(group)">
                            <div class="group-header">
                                <span :class="['badge', getSimilarityClass(group.similarity_type)]">
                                    {{ getSimilarityLabel(group.similarity_type) }}
                                </span>
                                <span class="member-count">{{ group.member_count }} images</span>
                            </div>
                            <div class="group-thumbnails">
                                <div v-for="member in group.members.slice(0, 4)" :key="member.image_id" class="group-thumb">
                                    <img :src="getDuplicateThumbnailUrl(member)"
                                         :alt="member.source_path"
                                         loading="lazy" />
                                    <span v-if="member.is_primary" class="primary-badge" title="Primary image">‚òÖ</span>
                                </div>
                                <div v-if="group.member_count > 4" class="more-count">
                                    +{{ group.member_count - 4 }}
                                </div>
                            </div>
                            <div class="group-footer">
                                <span v-if="group.reviewed" class="reviewed-badge">‚úì Reviewed</span>
                                <span class="confidence">{{ (group.confidence * 100).toFixed(0) }}% match</span>
                            </div>
                        </div>
                    </div>

                    <!-- Load More -->
                    <div v-if="hasMoreDuplicates() && !duplicatesLoading" class="load-more-container">
                        <button @click="loadDuplicates(false)" class="btn-secondary">
                            Load More ({{ formatNumber(duplicatesTotal - duplicateGroups.length) }} remaining)
                        </button>
                    </div>

                    <!-- Loading More Indicator -->
                    <div v-if="duplicatesLoading && duplicateGroups.length > 0" class="loading-more">
                        <div class="spinner"></div>
                        <span>Loading more...</span>
                    </div>
                </div>

                <!-- Duplicate Group Detail Modal -->
                <div v-if="selectedDuplicateGroup" class="modal-overlay" @click="closeDuplicateGroup">
                    <div class="modal-content modal-large" @click.stop>
                        <div class="modal-header">
                            <h3>Duplicate Group Details</h3>
                            <button @click="closeDuplicateGroup" class="modal-close">√ó</button>
                        </div>
                        <div class="duplicate-detail-content">
                            <div class="detail-header">
                                <span :class="['badge', getSimilarityClass(selectedDuplicateGroup.similarity_type)]">
                                    {{ getSimilarityLabel(selectedDuplicateGroup.similarity_type) }}
                                </span>
                                <span class="member-count">{{ selectedDuplicateGroup.member_count }} images</span>
                                <span class="confidence">{{ (selectedDuplicateGroup.confidence * 100).toFixed(0) }}% similarity</span>
                            </div>
                            <div class="duplicate-members-grid">
                                <div v-for="member in selectedDuplicateGroup.members" :key="member.image_id"
                                     class="duplicate-member"
                                     :class="{ 'is-primary': member.is_primary }">
                                    <div class="member-image">
                                        <img :src="getDuplicateThumbnailUrl(member)" :alt="member.source_path" />
                                        <span v-if="member.is_primary" class="primary-badge">‚òÖ Primary</span>
                                    </div>
                                    <div class="member-info">
                                        <div class="member-path" :title="member.source_path">
                                            {{ member.source_path.split('/').pop() }}
                                        </div>
                                        <div class="member-details">
                                            <span>{{ formatFileSize(member.size_bytes) }}</span>
                                            <span v-if="member.dates && member.dates.selected_date">
                                                {{ formatDate(member.dates.selected_date) }}
                                            </span>
                                        </div>
                                        <div class="member-similarity">
                                            Similarity: {{ member.similarity_score || 100 }}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button @click="closeDuplicateGroup" class="btn-secondary">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analyze Form Modal -->
        <div v-if="showAnalyzeForm" class="modal-overlay" @click="showAnalyzeForm = false">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>Analyze Catalog</h3>
                    <button type="button" @click="showPathHelp = true" class="btn" style="padding: 4px 8px; font-size: 12px;" title="View available paths">
                        üìÅ Path Help
                    </button>
                </div>
                <form @submit.prevent="submitAnalyzeJob">
                    <div class="form-group">
                        <label>Select Catalog</label>
                        <select v-model="analyzeForm.catalog_id" required>
                            <option :value="null" disabled>Choose a catalog...</option>
                            <option v-for="catalog in catalogs" :key="catalog.id" :value="catalog.id">
                                {{ catalog.name }}
                            </option>
                        </select>
                        <small v-if="analyzeForm.catalog_id && catalogs.find(c => c.id === analyzeForm.catalog_id)">
                            Will scan: {{ catalogs.find(c => c.id === analyzeForm.catalog_id).source_directories.join(', ') }}
                        </small>
                    </div>
                    <div class="form-group checkbox">
                        <label>
                            <input v-model="analyzeForm.detect_duplicates" type="checkbox" />
                            Detect Duplicates
                        </label>
                    </div>
                    <div class="form-group checkbox">
                        <label>
                            <input v-model="analyzeForm.force_reanalyze" type="checkbox" />
                            Reset Catalog (analyze all files fresh)
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" @click="showAnalyzeForm = false" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            Start Analysis
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Organize Form Modal -->
        <div v-if="showOrganizeForm" class="modal-overlay" @click="showOrganizeForm = false">
            <div class="modal-content" @click.stop>
                <h3>Organize Files</h3>
                <form @submit.prevent="submitOrganizeJob">
                    <div class="form-group">
                        <label>Select Catalog</label>
                        <select v-model="organizeForm.catalog_id" required>
                            <option :value="null" disabled>Choose a catalog...</option>
                            <option v-for="catalog in catalogs" :key="catalog.id" :value="catalog.id">
                                {{ catalog.name }}
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Output Directory</label>
                        <input v-model="organizeForm.output_directory" type="text" required 
                               placeholder="/app/organized" />
                    </div>
                    <div class="form-group">
                        <label>Pattern</label>
                        <input v-model="organizeForm.pattern" type="text" 
                               placeholder="{year}/{month}" />
                    </div>
                    <div class="form-group">
                        <label>Operation</label>
                        <select v-model="organizeForm.operation">
                            <option value="copy">Copy (Safe - keeps originals)</option>
                            <option value="move">Move (Deletes originals)</option>
                        </select>
                    </div>
                    <div class="form-group checkbox">
                        <label>
                            <input v-model="organizeForm.dry_run" type="checkbox" />
                            Dry Run (Preview only, no changes)
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" @click="showOrganizeForm = false" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            Start Organization
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Thumbnails Form Modal -->
        <div v-if="showThumbnailsForm" class="modal-overlay" @click="showThumbnailsForm = false">
            <div class="modal-content" @click.stop>
                <h3>Generate Thumbnails</h3>
                <form @submit.prevent="submitThumbnailsJob">
                    <div class="form-group">
                        <label>Select Catalog</label>
                        <select v-model="thumbnailsForm.catalog_id" required>
                            <option :value="null" disabled>Choose a catalog...</option>
                            <option v-for="catalog in catalogs" :key="catalog.id" :value="catalog.id">
                                {{ catalog.name }}
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sizes (comma-separated)</label>
                        <input v-model="thumbnailsForm.sizes" type="text" 
                               placeholder="200, 400, 800" />
                    </div>
                    <div class="form-group">
                        <label>Quality (1-100)</label>
                        <input v-model.number="thumbnailsForm.quality" type="number" 
                               min="1" max="100" required />
                    </div>
                    <div class="form-group checkbox">
                        <label>
                            <input v-model="thumbnailsForm.skip_existing" type="checkbox" />
                            Skip Existing Thumbnails
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" @click="showThumbnailsForm = false" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            Generate Thumbnails
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Catalog Form Modal -->
        <div v-if="showAddCatalogForm" class="modal-overlay" @click="showAddCatalogForm = false">
            <div class="modal-content" @click.stop>
                <h3>Add New Catalog</h3>
                <form @submit.prevent="submitAddCatalog">
                    <div class="form-group">
                        <label>Catalog Name</label>
                        <input v-model="addCatalogForm.name" type="text" required
                               placeholder="My Photo Collection" />
                    </div>
                    <div class="form-group">
                        <label>Catalog Storage Path</label>
                        <input v-model="addCatalogForm.catalog_path" type="text" required
                               placeholder="~/catalogs/my-photos" />
                        <small>Where catalog metadata will be stored (e.g., ~/catalogs/vacation-2024)</small>
                    </div>
                    <div class="form-group">
                        <label>Source Directories (one per line)</label>
                        <textarea v-model="addCatalogForm.source_directories"
                                  rows="3" required
                                  placeholder="~/photos/2023&#10;~/photos/2024"></textarea>
                        <small>Directories containing your original photos (e.g., ~/photos, ~/Pictures)</small>
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <input v-model="addCatalogForm.description" type="text"
                               placeholder="Family photos from 2023-2024" />
                    </div>
                    <div class="form-group">
                        <label>Color Tag</label>
                        <input v-model="addCatalogForm.color" type="color" />
                    </div>
                    <div class="form-actions">
                        <button type="button" @click="showAddCatalogForm = false" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            Add Catalog
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Catalog Form Modal -->
        <div v-if="showEditCatalogForm" class="modal-overlay" @click="showEditCatalogForm = false">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>Edit Catalog</h3>
                    <button type="button" @click="showPathHelp = true" class="btn" style="padding: 4px 8px; font-size: 12px;" title="View available paths">
                        üìÅ Path Help
                    </button>
                </div>
                <form @submit.prevent="submitEditCatalog">
                    <div class="form-group">
                        <label>Catalog Name</label>
                        <input v-model="editCatalogForm.name" type="text" required
                               placeholder="My Photo Collection" />
                    </div>
                    <div class="form-group">
                        <label>Source Directories (one per line)</label>
                        <textarea v-model="editCatalogForm.source_directories"
                                  rows="5" required
                                  placeholder="/host/home/username/Pictures&#10;/host/synology/photos"></textarea>
                        <small>Container paths to your image directories. Click "Path Help" above for examples.</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" @click="showEditCatalogForm = false" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            Update Catalog
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Job Stream Modal -->
        <div v-if="streamingJob" class="modal-overlay" @click="closeJobStream">
            <div class="modal-content modal-large" @click.stop>
                <div class="modal-header">
                    <h3>üì∫ Job Output: {{ streamingJob.name || streamingJob.id }}</h3>
                    <button @click="closeJobStream" class="modal-close">√ó</button>
                </div>
                <div class="job-stream-container">
                    <div class="stream-status">
                        <span :class="['status-badge', getJobStatusClass(streamingJob.status)]">
                            {{ formatJobStatus(streamingJob.status) }}
                        </span>
                        <span v-if="streamConnectionStatus" class="stream-connection-status" :class="streamConnectionStatus">
                            {{ streamConnectionStatusText }}
                        </span>
                    </div>
                    <!-- Progress stats badges -->
                    <div v-if="streamingJob.progress && Object.keys(streamingJob.progress).length > 0" class="stream-stats">
                        <span v-if="streamingJob.progress?.added" class="result-badge badge-success">
                            +{{ streamingJob.progress.added }} added
                        </span>
                        <span v-if="streamingJob.progress?.skipped" class="result-badge badge-muted">
                            {{ streamingJob.progress.skipped }} skipped
                        </span>
                        <span v-if="streamingJob.progress?.updated" class="result-badge badge-info">
                            {{ streamingJob.progress.updated }} updated
                        </span>
                        <span v-if="streamingJob.progress?.errors" class="result-badge badge-danger">
                            {{ streamingJob.progress.errors }} errors
                        </span>
                        <span v-if="streamingJob.progress?.processed" class="result-badge badge-info">
                            {{ streamingJob.progress.processed }} processed
                        </span>
                        <span v-if="streamingJob.progress?.files_added" class="result-badge badge-success">
                            +{{ streamingJob.progress.files_added }} files
                        </span>
                        <span v-if="streamingJob.progress?.organized" class="result-badge badge-success">
                            {{ streamingJob.progress.organized }} organized
                        </span>
                        <span v-if="streamingJob.progress?.generated" class="result-badge badge-success">
                            {{ streamingJob.progress.generated }} generated
                        </span>
                    </div>
                    <div class="stream-output" ref="streamOutput">
                        <div v-for="(event, index) in streamEvents" :key="index" class="stream-event">
                            <span class="stream-timestamp">{{ formatTime(event.timestamp) }}</span>
                            <span class="stream-message">{{ event.message }}</span>
                        </div>
                        <div v-if="streamEvents.length === 0" class="stream-empty">
                            Waiting for job output...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="clearStreamEvents" class="btn-secondary btn-small">
                        Clear
                    </button>
                    <button @click="closeJobStream" class="btn-primary">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Path Help Modal -->
        <div v-if="showPathHelp" class="modal-overlay" @click="showPathHelp = false">
            <div class="modal" @click.stop style="max-width: 700px;">
                <div class="modal-header">
                    <h3>Container Path Mappings</h3>
                    <button @click="showPathHelp = false" class="btn" style="padding: 4px 12px;">√ó</button>
                </div>
                <div class="modal-body">
                    <p class="text-secondary mb-md">
                        The VAM Tools container has access to the following directories on your host system.
                        Use these paths when creating catalogs or configuring scans.
                    </p>

                    <div class="card mb-md">
                        <h4 class="mb-sm">Host Directories</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <th style="text-align: left; padding: 8px; color: var(--text-muted); font-size: 11px; text-transform: uppercase;">Host Path</th>
                                    <th style="text-align: left; padding: 8px; color: var(--text-muted); font-size: 11px; text-transform: uppercase;">Container Path</th>
                                    <th style="text-align: left; padding: 8px; color: var(--text-muted); font-size: 11px; text-transform: uppercase;">Access</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--text-primary);">/home</td>
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--accent-primary);">/host/home</td>
                                    <td style="padding: 12px 8px; font-size: 12px; color: var(--text-secondary);">Read-only</td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--text-primary);">/mnt/synology</td>
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--accent-primary);">/host/synology</td>
                                    <td style="padding: 12px 8px; font-size: 12px; color: var(--text-secondary);">Read-only</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--text-primary);">~/catalogs</td>
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--accent-primary);">/app/catalogs</td>
                                    <td style="padding: 12px 8px; font-size: 12px; color: var(--text-secondary);">Read-write</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <h4 class="mb-sm">Example Paths</h4>
                        <div style="background-color: var(--bg-primary); padding: 12px; border-radius: var(--radius-sm); font-family: monospace; font-size: 12px;">
                            <div class="mb-sm" style="color: var(--text-muted);"># Your home directory pictures</div>
                            <div class="mb-md" style="color: var(--accent-success);">/host/home/irjudson/Pictures</div>

                            <div class="mb-sm" style="color: var(--text-muted);"># Synology NAS photos directory</div>
                            <div class="mb-md" style="color: var(--accent-success);">/host/synology/photos</div>

                            <div class="mb-sm" style="color: var(--text-muted);"># Multiple directories (one per line when creating catalog)</div>
                            <div style="color: var(--accent-success);">/host/home/irjudson/Pictures</div>
                            <div style="color: var(--accent-success);">/host/synology/photos</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="showPathHelp = false" class="btn primary">Got it!</button>
                </div>
            </div>
        </div>

        <!-- Scan Confirmation Modal -->
        <div v-if="showScanConfirmModal" class="modal-overlay" @click="showScanConfirmModal = false">
            <div class="modal-content" @click.stop>
                <h3>Confirm Scan Job</h3>
                <div style="margin: 20px 0;">
                    <p style="margin-bottom: 16px;">Start scanning files for catalog: <strong>{{ currentCatalog?.name }}</strong></p>
                    <div class="form-group">
                        <label>Directories to scan:</label>
                        <ul style="list-style: none; padding-left: 0; margin-top: 8px;">
                            <li v-for="dir in currentCatalog?.source_directories"
                                :key="dir"
                                style="padding: 6px 12px; margin-bottom: 4px; background: var(--bg-secondary); border-radius: 4px; font-family: monospace; font-size: 13px;">
                                {{ dir }}
                            </li>
                        </ul>
                    </div>
                    <p style="margin-top: 16px; font-size: 14px; color: var(--text-secondary);">
                        This will scan all image and video files in the specified directories, extract metadata, and generate thumbnails.
                    </p>
                    <div class="form-group" style="margin-top: 16px;">
                        <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" v-model="scanContinuePipeline" style="width: 18px; height: 18px;">
                            <span>Continue with Auto-Tag and Find Duplicates when done</span>
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" @click="showScanConfirmModal = false" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="button" @click="confirmScan" class="btn-primary">
                        Start Scan
                    </button>
                </div>
            </div>
        </div>

        <!-- Auto-Tag Confirmation Modal -->
        <div v-if="showAutoTagConfirmModal" class="modal-overlay" @click="showAutoTagConfirmModal = false">
            <div class="modal-content" @click.stop>
                <h3>Confirm Auto-Tagging</h3>
                <div style="margin: 20px 0;">
                    <p style="margin-bottom: 16px;">Start AI-powered tagging for catalog: <strong>{{ currentCatalog?.name }}</strong></p>
                    <div class="form-group">
                        <label>Tagging Backend:</label>
                        <select v-model="autoTagBackend" style="width: 100%; padding: 8px; margin-top: 4px; border-radius: 4px; background: var(--bg-secondary); border: 1px solid var(--border-color);">
                            <option value="openclip">OpenCLIP (Fast, GPU accelerated)</option>
                            <option value="ollama">Ollama/LLaVA (More accurate, slower)</option>
                            <option value="combined">Combined (Both backends, weighted confidence)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top: 12px;">
                        <label>Tagging Mode:</label>
                        <select v-model="autoTagMode" style="width: 100%; padding: 8px; margin-top: 4px; border-radius: 4px; background: var(--bg-secondary); border: 1px solid var(--border-color);">
                            <option value="untagged_only">Tag only untagged images (faster)</option>
                            <option value="all">Retag all images (overwrites existing AI tags)</option>
                        </select>
                    </div>
                    <p style="margin-top: 16px; font-size: 14px; color: var(--text-secondary);">
                        This will analyze images using AI and automatically assign relevant tags based on content (subjects, scenes, lighting, mood, etc.).
                    </p>
                    <div class="form-group" style="margin-top: 16px;">
                        <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" v-model="autoTagContinuePipeline" style="width: 18px; height: 18px;">
                            <span>Continue with Find Duplicates when done</span>
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" @click="showAutoTagConfirmModal = false" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="button" @click="confirmAutoTag" class="btn-primary">
                        Start Auto-Tagging
                    </button>
                </div>
            </div>
        </div>

        <!-- Find Duplicates Confirmation Modal -->
        <div v-if="showDuplicatesConfirmModal" class="modal-overlay" @click="showDuplicatesConfirmModal = false">
            <div class="modal-content" @click.stop>
                <h3>Confirm Duplicate Detection</h3>
                <div style="margin: 20px 0;">
                    <p style="margin-bottom: 16px;">Start duplicate detection for catalog: <strong>{{ currentCatalog?.name }}</strong></p>
                    <div class="form-group">
                        <label>Directories to analyze:</label>
                        <ul style="list-style: none; padding-left: 0; margin-top: 8px;">
                            <li v-for="dir in currentCatalog?.source_directories"
                                :key="dir"
                                style="padding: 6px 12px; margin-bottom: 4px; background: var(--bg-secondary); border-radius: 4px; font-family: monospace; font-size: 13px;">
                                {{ dir }}
                            </li>
                        </ul>
                    </div>
                    <p style="margin-top: 16px; font-size: 14px; color: var(--text-secondary);">
                        This will analyze all files, detect duplicates using perceptual hashing, and group similar images together.
                        This process may take some time depending on the number of files.
                    </p>
                </div>
                <div class="form-actions">
                    <button type="button" @click="showDuplicatesConfirmModal = false" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="button" @click="confirmFindDuplicates" class="btn-primary">
                        Start Duplicate Detection
                    </button>
                </div>
            </div>
        </div>

        <!-- Lightbox Viewer -->
        <div v-if="lightboxVisible" class="lightbox" @click.self="closeLightbox">
            <div class="lightbox-container">
                <!-- Main Image Area -->
                <div class="lightbox-main">
                    <!-- Navigation Buttons -->
                    <div class="lightbox-nav prev">
                        <button @click="prevImage" :disabled="lightboxImageIndex === 0" title="Previous (‚Üê)">
                            ‚Üê
                        </button>
                    </div>

                    <div class="lightbox-nav next">
                        <button @click="nextImage" :disabled="lightboxImageIndex >= images.length - 1" title="Next (‚Üí)">
                            ‚Üí
                        </button>
                    </div>

                    <!-- Close Button -->
                    <button class="lightbox-close" @click="closeLightbox" title="Close (ESC)">
                        √ó
                    </button>

                    <!-- Image -->
                    <div class="lightbox-image-wrapper">
                        <img
                            v-if="lightboxImage"
                            :src="getFullImageUrl(lightboxImage)"
                            :alt="lightboxImage.source_path"
                            class="lightbox-image"
                        />
                    </div>
                </div>

                <!-- Sidebar with Metadata -->
                <div class="lightbox-sidebar">
                    <h3 class="mb-md">Image Details</h3>

                    <!-- Find Similar Action -->
                    <div class="lightbox-actions">
                        <button
                            @click="findSimilarImages(lightboxImage.id); closeLightbox();"
                            class="lightbox-action-btn"
                            title="Find Similar Images"
                        >
                            Find Similar Images
                        </button>
                    </div>

                    <!-- File Info -->
                    <div class="lightbox-metadata-section">
                        <h3>File Information</h3>
                        <div v-if="lightboxImage">
                            <div class="lightbox-metadata-item">
                                <span class="lightbox-metadata-label">Filename</span>
                                <span class="lightbox-metadata-value">
                                    {{ lightboxImage.source_path.split('/').pop() }}
                                </span>
                            </div>
                            <div class="lightbox-metadata-item">
                                <span class="lightbox-metadata-label">Path</span>
                                <span class="lightbox-metadata-value">
                                    {{ lightboxImage.source_path }}
                                </span>
                            </div>
                            <div class="lightbox-metadata-item">
                                <span class="lightbox-metadata-label">Type</span>
                                <span class="lightbox-metadata-value">
                                    {{ lightboxImage.file_type || 'Unknown' }}
                                </span>
                            </div>
                            <div class="lightbox-metadata-item">
                                <span class="lightbox-metadata-label">Size</span>
                                <span class="lightbox-metadata-value">
                                    {{ formatFileSize(lightboxImage.size_bytes) }}
                                </span>
                            </div>
                            <div class="lightbox-metadata-item">
                                <span class="lightbox-metadata-label">Checksum</span>
                                <span class="lightbox-metadata-value" style="font-family: monospace; font-size: 10px;">
                                    {{ lightboxImage.checksum ? lightboxImage.checksum.substring(0, 12) + '...' : 'N/A' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div class="lightbox-metadata-section" v-if="lightboxImage && lightboxImage.tags && lightboxImage.tags.length > 0">
                        <h3>Tags</h3>
                        <div class="lightbox-tags">
                            <span
                                v-for="tag in lightboxImage.tags"
                                :key="tag.name"
                                class="lightbox-tag"
                                :title="'Confidence: ' + Math.round((tag.confidence || 0) * 100) + '%'"
                            >
                                {{ tag.name }}
                            </span>
                        </div>
                    </div>

                    <!-- Dates -->
                    <div class="lightbox-metadata-section" v-if="lightboxImage && lightboxImage.dates">
                        <h3>Dates</h3>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.dates.created">
                            <span class="lightbox-metadata-label">Created</span>
                            <span class="lightbox-metadata-value">
                                {{ formatDate(lightboxImage.dates.created) }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.dates.modified">
                            <span class="lightbox-metadata-label">Modified</span>
                            <span class="lightbox-metadata-value">
                                {{ formatDate(lightboxImage.dates.modified) }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.dates.taken">
                            <span class="lightbox-metadata-label">Taken</span>
                            <span class="lightbox-metadata-value">
                                {{ formatDate(lightboxImage.dates.taken) }}
                            </span>
                        </div>
                    </div>

                    <!-- EXIF Metadata -->
                    <div class="lightbox-metadata-section" v-if="lightboxImage && lightboxImage.metadata">
                        <h3>EXIF Data</h3>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.camera">
                            <span class="lightbox-metadata-label">Camera</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImage.metadata.camera }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.lens">
                            <span class="lightbox-metadata-label">Lens</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImage.metadata.lens }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.iso">
                            <span class="lightbox-metadata-label">ISO</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImage.metadata.iso }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.aperture">
                            <span class="lightbox-metadata-label">Aperture</span>
                            <span class="lightbox-metadata-value">
                                f/{{ lightboxImage.metadata.aperture }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.shutter_speed">
                            <span class="lightbox-metadata-label">Shutter</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImage.metadata.shutter_speed }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.focal_length">
                            <span class="lightbox-metadata-label">Focal Length</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImage.metadata.focal_length }}mm
                            </span>
                        </div>
                    </div>

                    <!-- Navigation Info -->
                    <div class="lightbox-metadata-section">
                        <h3>Navigation</h3>
                        <div class="lightbox-metadata-item">
                            <span class="lightbox-metadata-label">Position</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImageIndex + 1 }} of {{ images.length }}
                            </span>
                        </div>
                    </div>

                    <!-- Keyboard Shortcuts -->
                    <div class="lightbox-metadata-section">
                        <h3>Keyboard Shortcuts</h3>
                        <div class="lightbox-metadata-item">
                            <span class="lightbox-metadata-label">Previous</span>
                            <span class="lightbox-metadata-value">‚Üê Left Arrow</span>
                        </div>
                        <div class="lightbox-metadata-item">
                            <span class="lightbox-metadata-label">Next</span>
                            <span class="lightbox-metadata-value">‚Üí Right Arrow</span>
                        </div>
                        <div class="lightbox-metadata-item">
                            <span class="lightbox-metadata-label">Close</span>
                            <span class="lightbox-metadata-value">ESC</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Burst Detail Modal -->
        <div v-if="showBurstModal && currentBurst" class="modal-overlay" @click.self="showBurstModal = false">
            <div class="modal burst-modal">
                <div class="modal-header">
                    <h3>Burst: {{ currentBurst.image_count }} images</h3>
                    <button @click="showBurstModal = false" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="burst-info">
                        <p v-if="currentBurst.camera_make || currentBurst.camera_model">
                            <strong>Camera:</strong> {{ currentBurst.camera_make }} {{ currentBurst.camera_model }}
                        </p>
                        <p v-if="currentBurst.duration_seconds !== null && currentBurst.duration_seconds !== undefined">
                            <strong>Duration:</strong> {{ currentBurst.duration_seconds.toFixed(1) }}s
                        </p>
                        <p v-if="currentBurst.start_time">
                            <strong>Time:</strong> {{ formatDate(currentBurst.start_time) }}
                        </p>
                    </div>
                    <div class="burst-images-grid">
                        <div
                            v-for="image in currentBurst.images"
                            :key="image.id"
                            class="burst-image-item"
                            :class="{ 'is-best': image.is_best }"
                            @click="setBestImage(currentBurst.id, image.id)"
                        >
                            <img :src="image.thumbnail_url" :alt="image.source_path">
                            <div class="burst-image-overlay">
                                <span v-if="image.is_best" class="best-badge">BEST</span>
                                <span v-if="image.quality_score !== null && image.quality_score !== undefined" class="quality-score">
                                    Q: {{ (image.quality_score * 100).toFixed(0) }}%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/app.js?v=29"></script>
</body>
</html>
