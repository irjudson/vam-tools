<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAM Tools - Media Catalog Management</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/static/dark-theme.css">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div id="app">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-container">
                <div class="nav-brand">
                    <h1>VAM Tools</h1>
                </div>

                <!-- Catalog Selector (primary position) -->
                <div class="catalog-selector">
                    <button @click="showCatalogManager = !showCatalogManager" class="catalog-button">
                        <span v-if="currentCatalog" :style="{color: currentCatalog.color}">
                            üìÅ {{ currentCatalog.name }}
                        </span>
                        <span v-else>üìÅ Select Catalog</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>

                    <div v-if="showCatalogManager" class="catalog-dropdown">
                        <div class="catalog-list">
                            <div v-if="catalogs.length === 0" class="empty-catalogs">
                                No catalogs configured. Add one to get started!
                            </div>
                            <div v-for="catalog in catalogs" :key="catalog.id"
                                 :class="['catalog-item', {active: currentCatalog && currentCatalog.id === catalog.id}]">
                                <div class="catalog-color" :style="{background: catalog.color}"></div>
                                <div class="catalog-info" @click="switchCatalog(catalog); showCatalogManager = false">
                                    <div class="catalog-name">{{ catalog.name }}</div>
                                    <div class="catalog-path">{{ catalog.source_directories.map(d => displayPath(d)).join(', ') }}</div>
                                </div>
                                <button
                                    @click.stop="openEditCatalog(catalog)"
                                    class="catalog-edit-btn"
                                    title="Edit catalog"
                                    style="margin-right: 4px;">
                                    ‚úé
                                </button>
                                <button
                                    @click.stop="deleteCatalog(catalog.id)"
                                    class="catalog-delete-btn"
                                    title="Delete catalog configuration">
                                    √ó
                                </button>
                            </div>
                        </div>
                        <div class="catalog-actions">
                            <button @click="showAddCatalogForm = true; showCatalogManager = false" class="btn-primary btn-small">
                                + Add Catalog
                            </button>
                        </div>
                    </div>
                </div>

                <div class="nav-menu">
                    <button
                        @click="setView('browse')"
                        :class="{'active': currentView === 'browse'}"
                        class="nav-button">
                        üè† Home
                    </button>
                    <button
                        @click="setView('jobs')"
                        :class="{'active': currentView === 'jobs'}"
                        class="nav-button">
                        ‚öôÔ∏è Jobs
                        <span v-if="hasActiveJobs" class="badge">{{ activeJobs.length }}</span>
                    </button>

                    <!-- Worker Health Indicator -->
                    <div class="worker-health" :class="'health-' + workerHealth.status" :title="workerHealth.message">
                        <span class="health-dot"></span>
                        <span class="health-text">{{ workerHealth.workers }} worker{{ workerHealth.workers !== 1 ? 's' : '' }}</span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Notifications -->
        <div class="notifications">
            <div v-for="notification in notifications" :key="notification.id"
                 :class="['notification', `notification-${notification.type}`]">
                {{ notification.message }}
                <button @click="removeNotification(notification.id)" class="notification-close">√ó</button>
            </div>
        </div>

        <!-- Main Browse View (default home page) -->
        <div v-if="currentView === 'browse'" class="view-container">
            <div class="content-wrapper">
                <!-- Actions Panel -->
                <div v-if="currentCatalog" class="actions-panel">
                    <div class="actions-grid">
                        <button @click="startScan" class="action-btn" :disabled="!currentCatalog">
                            <span class="action-icon">üìÇ</span>
                            <div class="action-text">
                                <div class="action-title">Find Files</div>
                                <div class="action-desc">Scan directories for media</div>
                            </div>
                        </button>
                        <button @click="startFindDuplicates" class="action-btn" :disabled="!currentCatalog">
                            <span class="action-icon">üîç</span>
                            <div class="action-text">
                                <div class="action-title">Find Duplicates</div>
                                <div class="action-desc">Detect duplicate files</div>
                            </div>
                        </button>
                        <button @click="setView('review')" class="action-btn" :disabled="!currentCatalog || reviewQueueStats.total_needing_review === 0">
                            <span class="action-icon">üìù</span>
                            <div class="action-text">
                                <div class="action-title">Review Duplicates</div>
                                <div class="action-desc" v-if="reviewQueueStats.total_needing_review > 0">{{ reviewQueueStats.total_needing_review }} groups to review</div>
                                <div class="action-desc" v-else>No duplicates to review</div>
                            </div>
                        </button>
                        <button @click="startFindFaces" class="action-btn" :disabled="!currentCatalog" style="opacity: 0.5;">
                            <span class="action-icon">üë§</span>
                            <div class="action-text">
                                <div class="action-title">Find Faces</div>
                                <div class="action-desc">Coming soon</div>
                            </div>
                        </button>
                    </div>
                </div>

                <div class="browse-header">
                    <h2 v-if="currentCatalog">{{ images.length }} of {{ formatNumber(imagesTotal) }} images</h2>
                    <h2 v-else>Select a Catalog</h2>
                    <div v-if="currentCatalog" class="browse-controls">
                        <!-- Thumbnail Size Selector -->
                        <select v-model="thumbnailSize" class="size-selector">
                            <option value="small">Small</option>
                            <option value="medium">Medium</option>
                            <option value="large">Large</option>
                        </select>
                    </div>
                </div>

                <!-- Loading State -->
                <div v-if="imagesLoading && images.length === 0" class="text-center p-lg">
                    <div class="spinner"></div>
                    <p class="text-secondary mt-md">Loading images...</p>
                </div>

                <!-- No Catalog Selected -->
                <div v-else-if="!currentCatalog" class="text-center p-lg">
                    <p class="text-secondary">Please select a catalog to browse images</p>
                </div>

                <!-- Empty State -->
                <div v-else-if="images.length === 0 && !imagesLoading" class="text-center p-lg">
                    <p class="text-secondary">No images found in this catalog</p>
                    <button @click="loadImages(true)" class="btn mt-md">Refresh</button>
                </div>

                <!-- Image Grid -->
                <div v-else :class="['grid', thumbnailGridClass]">
                    <div
                        v-for="(image, index) in images"
                        :key="image.id"
                        class="thumbnail"
                        :class="{'selected': isImageSelected(image.id)}"
                        @click="openLightbox(index)"
                    >
                        <img
                            :src="getThumbnailUrl(image)"
                            :alt="image.source_path"
                            loading="lazy"
                        />
                        <div class="thumbnail-overlay">
                            <div class="text-sm">{{ image.source_path.split('/').pop() }}</div>
                        </div>
                    </div>
                </div>

                <!-- Load More Button -->
                <div v-if="hasMoreImages && !imagesLoading" class="text-center mt-lg">
                    <button @click="loadImages(false)" class="btn">
                        Load More Images
                    </button>
                </div>

                <!-- Loading More Indicator -->
                <div v-if="imagesLoading && images.length > 0" class="text-center mt-lg">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Jobs View -->
        <div v-if="currentView === 'jobs'" class="view-container">
            <div class="content-wrapper">
                <h2>Job Management</h2>

                <!-- Active Jobs -->
                <section v-if="activeJobs.length > 0" class="active-jobs-section">
                    <h3>Active Jobs ({{ activeJobs.length }})</h3>
                    <div class="jobs-grid">
                        <div v-for="job in activeJobs" :key="job.id" class="job-card active">
                            <div class="job-header">
                                <strong>{{ job.name || 'Job' }}</strong>
                                <span :class="['status-badge', getJobStatusClass(job.status)]">
                                    {{ formatJobStatus(job.status) }}
                                </span>
                            </div>
                            <div class="job-id">ID: {{ job.id }}</div>
                            <!-- Stats display for all jobs -->
                            <div v-if="(job.progress && Object.keys(job.progress).length > 0) || (job.result && Object.keys(job.result).length > 0)" class="job-stats-display">
                                <div class="table-result-stats">
                                    <span v-if="'added' in (job.progress || {}) || 'added' in (job.result || {})" class="result-badge badge-success">
                                        +{{ job.progress?.added ?? job.result?.added ?? 0 }} added
                                    </span>
                                    <span v-if="'skipped' in (job.progress || {}) || 'skipped' in (job.result || {})" class="result-badge badge-muted">
                                        {{ job.progress?.skipped ?? job.result?.skipped ?? 0 }} skipped
                                    </span>
                                    <span v-if="'updated' in (job.progress || {}) || 'updated' in (job.result || {})" class="result-badge badge-warning">
                                        {{ job.progress?.updated ?? job.result?.updated ?? 0 }} updated
                                    </span>
                                    <span v-if="('errors' in (job.progress || {}) && job.progress.errors > 0) || ('errors' in (job.result || {}) && job.result.errors > 0)" class="result-badge badge-danger">
                                        {{ job.progress?.errors ?? job.result?.errors ?? 0 }} errors
                                    </span>
                                    <span v-if="'processed' in (job.progress || {}) || 'processed' in (job.result || {})" class="result-badge badge-info">
                                        {{ job.progress?.processed ?? job.result?.processed ?? 0 }} processed
                                    </span>
                                    <span v-if="'files_added' in (job.progress || {}) || 'files_added' in (job.result || {})" class="result-badge badge-success">
                                        +{{ job.progress?.files_added ?? job.result?.files_added ?? 0 }} files
                                    </span>
                                    <span v-if="'organized' in (job.progress || {}) || 'organized' in (job.result || {})" class="result-badge badge-success">
                                        {{ job.progress?.organized ?? job.result?.organized ?? 0 }} organized
                                    </span>
                                    <span v-if="'generated' in (job.progress || {}) || 'generated' in (job.result || {})" class="result-badge badge-success">
                                        {{ job.progress?.generated ?? job.result?.generated ?? 0 }} generated
                                    </span>
                                </div>
                            </div>
                            <div v-if="job.error" class="job-error-summary">
                                <div class="error-label">‚úó Error</div>
                                <div class="error-text">{{ job.error }}</div>
                            </div>
                            <div class="job-actions">
                                <button v-if="job.status === 'PROGRESS' || job.status === 'PENDING'"
                                        @click="cancelJob(job.id)" class="btn-secondary btn-small" title="Stop job gracefully">
                                    Cancel
                                </button>
                                <button v-if="job.status === 'PROGRESS' || job.status === 'PENDING'"
                                        @click="killJob(job.id)" class="btn-danger btn-small" title="Force kill stuck job">
                                    Force Kill
                                </button>
                                <button @click="rerunJob(job.id)" class="btn-primary btn-small" title="Rerun job with same parameters">
                                    üîÑ Rerun
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- All Jobs -->
                <section class="all-jobs-section">
                    <h3>All Jobs</h3>
                    <div class="jobs-table">
                        <table v-if="jobs.length > 0">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Result</th>
                                    <th>Started</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="job in jobs" :key="job.id">
                                    <td>{{ job.name || 'Unknown' }}</td>
                                    <td>
                                        <span :class="['status-badge', getJobStatusClass(job.status)]">
                                            {{ formatJobStatus(job.status) }}
                                        </span>
                                    </td>
                                    <td>
                                        <div v-if="(job.progress && Object.keys(job.progress).length > 0) || (job.result && Object.keys(job.result).length > 0)" class="table-result-stats">
                                            <span v-if="'added' in (job.progress || {}) || 'added' in (job.result || {})" class="result-badge badge-success">
                                                +{{ job.progress?.added ?? job.result?.added ?? 0 }} added
                                            </span>
                                            <span v-if="'skipped' in (job.progress || {}) || 'skipped' in (job.result || {})" class="result-badge badge-muted">
                                                {{ job.progress?.skipped ?? job.result?.skipped ?? 0 }} skipped
                                            </span>
                                            <span v-if="'updated' in (job.progress || {}) || 'updated' in (job.result || {})" class="result-badge badge-warning">
                                                {{ job.progress?.updated ?? job.result?.updated ?? 0 }} updated
                                            </span>
                                            <span v-if="('errors' in (job.progress || {}) && job.progress.errors > 0) || ('errors' in (job.result || {}) && job.result.errors > 0)" class="result-badge badge-danger">
                                                {{ job.progress?.errors ?? job.result?.errors ?? 0 }} errors
                                            </span>
                                            <span v-if="'processed' in (job.progress || {}) || 'processed' in (job.result || {})" class="result-badge badge-info">
                                                {{ job.progress?.processed ?? job.result?.processed ?? 0 }} processed
                                            </span>
                                            <span v-if="'files_added' in (job.progress || {}) || 'files_added' in (job.result || {})" class="result-badge badge-success">
                                                +{{ job.progress?.files_added ?? job.result?.files_added ?? 0 }} files
                                            </span>
                                            <span v-if="'organized' in (job.progress || {}) || 'organized' in (job.result || {})" class="result-badge badge-success">
                                                {{ job.progress?.organized ?? job.result?.organized ?? 0 }} organized
                                            </span>
                                            <span v-if="'generated' in (job.progress || {}) || 'generated' in (job.result || {})" class="result-badge badge-success">
                                                {{ job.progress?.generated ?? job.result?.generated ?? 0 }} generated
                                            </span>
                                        </div>
                                        <div v-else-if="job.error" class="table-error">
                                            <span class="result-badge badge-danger">Error</span>
                                        </div>
                                        <span v-else>-</span>
                                    </td>
                                    <td>{{ formatDate(job.started) }}</td>
                                    <td>
                                        <div class="job-actions-inline">
                                            <button v-if="job.status === 'PROGRESS' || job.status === 'PENDING'"
                                                @click="cancelJob(job.id)"
                                                class="btn-secondary btn-small"
                                                title="Cancel job">
                                                Cancel
                                            </button>
                                            <button v-if="job.status === 'PROGRESS' || job.status === 'PENDING'"
                                                @click="killJob(job.id)"
                                                class="btn-danger btn-small"
                                                title="Force kill">
                                                Kill
                                            </button>
                                            <button
                                                @click="rerunJob(job.id)"
                                                class="btn-primary btn-small"
                                                title="Rerun job">
                                                üîÑ
                                            </button>
                                            <button
                                                @click="showJobStream(job.id)"
                                                class="btn-secondary btn-small"
                                                title="View streaming output">
                                                üì∫
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div v-else class="empty-state">
                            No jobs yet. Start by using the Quick Actions on the Dashboard!
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Review Queue View -->
        <div v-if="currentView === 'review'" class="view-container">
            <div class="content-wrapper">
                <h2>Review Queue</h2>

                <section class="review-stats">
                    <h3>Overview</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Total Items</h4>
                            <div class="stat-value">{{ reviewQueueStats.total_needing_review }}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Date Conflicts</h4>
                            <div class="stat-value">{{ reviewQueueStats.date_conflicts }}</div>
                        </div>
                        <div class="stat-card">
                            <h4>No Date</h4>
                            <div class="stat-value">{{ reviewQueueStats.no_date }}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Suspicious Dates</h4>
                            <div class="stat-value">{{ reviewQueueStats.suspicious_dates }}</div>
                        </div>
                    </div>
                </section>

                <section class="review-items">
                    <h3>Items Needing Review</h3>
                    <div v-if="reviewQueue.length > 0" class="review-list">
                        <div v-for="item in reviewQueue" :key="item.id" class="review-card">
                            <div class="review-thumbnail">
                                <img :src="item.thumbnail_path ? `/api/images/${item.id}/thumbnail` : `/api/preview/${encodeURIComponent(item.source_path)}`" 
                                     :alt="item.source_path"
                                     loading="lazy"
                                />
                            </div>
                            <div class="review-info">
                                <div class="review-path">{{ item.source_path }}</div>
                                <div class="review-reason">Reason: {{ item.type.replace('_', ' ') }}</div>
                                <div v-if="item.current_date" class="review-current-date">
                                    Current Date: {{ formatDate(item.current_date) }}
                                </div>
                                <div v-if="item.confidence" class="review-confidence">
                                    Confidence: {{ item.confidence }}%
                                </div>
                                <div class="review-actions">
                                    <button @click="resolveReviewItem(item.id)" class="btn-primary btn-small">
                                        Resolve
                                    </button>
                                    <button @click="skipReviewItem(item.id)" class="btn-secondary btn-small">
                                        Skip
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else class="empty-state">
                        No items currently in the review queue.
                    </div>
                </section>
            </div>
        </div>

        <!-- Analyze Form Modal -->
        <div v-if="showAnalyzeForm" class="modal-overlay" @click="showAnalyzeForm = false">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>Analyze Catalog</h3>
                    <button type="button" @click="showPathHelp = true" class="btn" style="padding: 4px 8px; font-size: 12px;" title="View available paths">
                        üìÅ Path Help
                    </button>
                </div>
                <form @submit.prevent="submitAnalyzeJob">
                    <div class="form-group">
                        <label>Select Catalog</label>
                        <select v-model="analyzeForm.catalog_id" required>
                            <option :value="null" disabled>Choose a catalog...</option>
                            <option v-for="catalog in catalogs" :key="catalog.id" :value="catalog.id">
                                {{ catalog.name }}
                            </option>
                        </select>
                        <small v-if="analyzeForm.catalog_id && catalogs.find(c => c.id === analyzeForm.catalog_id)">
                            Will scan: {{ catalogs.find(c => c.id === analyzeForm.catalog_id).source_directories.join(', ') }}
                        </small>
                    </div>
                    <div class="form-group checkbox">
                        <label>
                            <input v-model="analyzeForm.detect_duplicates" type="checkbox" />
                            Detect Duplicates
                        </label>
                    </div>
                    <div class="form-group checkbox">
                        <label>
                            <input v-model="analyzeForm.force_reanalyze" type="checkbox" />
                            Reset Catalog (analyze all files fresh)
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" @click="showAnalyzeForm = false" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            Start Analysis
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Organize Form Modal -->
        <div v-if="showOrganizeForm" class="modal-overlay" @click="showOrganizeForm = false">
            <div class="modal-content" @click.stop>
                <h3>Organize Files</h3>
                <form @submit.prevent="submitOrganizeJob">
                    <div class="form-group">
                        <label>Select Catalog</label>
                        <select v-model="organizeForm.catalog_id" required>
                            <option :value="null" disabled>Choose a catalog...</option>
                            <option v-for="catalog in catalogs" :key="catalog.id" :value="catalog.id">
                                {{ catalog.name }}
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Output Directory</label>
                        <input v-model="organizeForm.output_directory" type="text" required 
                               placeholder="/app/organized" />
                    </div>
                    <div class="form-group">
                        <label>Pattern</label>
                        <input v-model="organizeForm.pattern" type="text" 
                               placeholder="{year}/{month}" />
                    </div>
                    <div class="form-group">
                        <label>Operation</label>
                        <select v-model="organizeForm.operation">
                            <option value="copy">Copy (Safe - keeps originals)</option>
                            <option value="move">Move (Deletes originals)</option>
                        </select>
                    </div>
                    <div class="form-group checkbox">
                        <label>
                            <input v-model="organizeForm.dry_run" type="checkbox" />
                            Dry Run (Preview only, no changes)
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" @click="showOrganizeForm = false" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            Start Organization
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Thumbnails Form Modal -->
        <div v-if="showThumbnailsForm" class="modal-overlay" @click="showThumbnailsForm = false">
            <div class="modal-content" @click.stop>
                <h3>Generate Thumbnails</h3>
                <form @submit.prevent="submitThumbnailsJob">
                    <div class="form-group">
                        <label>Select Catalog</label>
                        <select v-model="thumbnailsForm.catalog_id" required>
                            <option :value="null" disabled>Choose a catalog...</option>
                            <option v-for="catalog in catalogs" :key="catalog.id" :value="catalog.id">
                                {{ catalog.name }}
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sizes (comma-separated)</label>
                        <input v-model="thumbnailsForm.sizes" type="text" 
                               placeholder="200, 400, 800" />
                    </div>
                    <div class="form-group">
                        <label>Quality (1-100)</label>
                        <input v-model.number="thumbnailsForm.quality" type="number" 
                               min="1" max="100" required />
                    </div>
                    <div class="form-group checkbox">
                        <label>
                            <input v-model="thumbnailsForm.skip_existing" type="checkbox" />
                            Skip Existing Thumbnails
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" @click="showThumbnailsForm = false" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            Generate Thumbnails
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Catalog Form Modal -->
        <div v-if="showAddCatalogForm" class="modal-overlay" @click="showAddCatalogForm = false">
            <div class="modal-content" @click.stop>
                <h3>Add New Catalog</h3>
                <form @submit.prevent="submitAddCatalog">
                    <div class="form-group">
                        <label>Catalog Name</label>
                        <input v-model="addCatalogForm.name" type="text" required
                               placeholder="My Photo Collection" />
                    </div>
                    <div class="form-group">
                        <label>Catalog Storage Path</label>
                        <input v-model="addCatalogForm.catalog_path" type="text" required
                               placeholder="~/catalogs/my-photos" />
                        <small>Where catalog metadata will be stored (e.g., ~/catalogs/vacation-2024)</small>
                    </div>
                    <div class="form-group">
                        <label>Source Directories (one per line)</label>
                        <textarea v-model="addCatalogForm.source_directories"
                                  rows="3" required
                                  placeholder="~/photos/2023&#10;~/photos/2024"></textarea>
                        <small>Directories containing your original photos (e.g., ~/photos, ~/Pictures)</small>
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <input v-model="addCatalogForm.description" type="text"
                               placeholder="Family photos from 2023-2024" />
                    </div>
                    <div class="form-group">
                        <label>Color Tag</label>
                        <input v-model="addCatalogForm.color" type="color" />
                    </div>
                    <div class="form-actions">
                        <button type="button" @click="showAddCatalogForm = false" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            Add Catalog
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Catalog Form Modal -->
        <div v-if="showEditCatalogForm" class="modal-overlay" @click="showEditCatalogForm = false">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>Edit Catalog</h3>
                    <button type="button" @click="showPathHelp = true" class="btn" style="padding: 4px 8px; font-size: 12px;" title="View available paths">
                        üìÅ Path Help
                    </button>
                </div>
                <form @submit.prevent="submitEditCatalog">
                    <div class="form-group">
                        <label>Catalog Name</label>
                        <input v-model="editCatalogForm.name" type="text" required
                               placeholder="My Photo Collection" />
                    </div>
                    <div class="form-group">
                        <label>Source Directories (one per line)</label>
                        <textarea v-model="editCatalogForm.source_directories"
                                  rows="5" required
                                  placeholder="/host/home/username/Pictures&#10;/host/synology/photos"></textarea>
                        <small>Container paths to your image directories. Click "Path Help" above for examples.</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" @click="showEditCatalogForm = false" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            Update Catalog
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Job Stream Modal -->
        <div v-if="streamingJob" class="modal-overlay" @click="closeJobStream">
            <div class="modal-content modal-large" @click.stop>
                <div class="modal-header">
                    <h3>üì∫ Job Output: {{ streamingJob.name || streamingJob.id }}</h3>
                    <button @click="closeJobStream" class="modal-close">√ó</button>
                </div>
                <div class="job-stream-container">
                    <div class="stream-status">
                        <span :class="['status-badge', getJobStatusClass(streamingJob.status)]">
                            {{ formatJobStatus(streamingJob.status) }}
                        </span>
                        <span v-if="streamConnectionStatus" class="stream-connection-status" :class="streamConnectionStatus">
                            {{ streamConnectionStatusText }}
                        </span>
                    </div>
                    <!-- Progress stats badges -->
                    <div v-if="streamingJob.progress && Object.keys(streamingJob.progress).length > 0" class="stream-stats">
                        <span v-if="streamingJob.progress?.added" class="result-badge badge-success">
                            +{{ streamingJob.progress.added }} added
                        </span>
                        <span v-if="streamingJob.progress?.skipped" class="result-badge badge-muted">
                            {{ streamingJob.progress.skipped }} skipped
                        </span>
                        <span v-if="streamingJob.progress?.updated" class="result-badge badge-info">
                            {{ streamingJob.progress.updated }} updated
                        </span>
                        <span v-if="streamingJob.progress?.errors" class="result-badge badge-danger">
                            {{ streamingJob.progress.errors }} errors
                        </span>
                        <span v-if="streamingJob.progress?.processed" class="result-badge badge-info">
                            {{ streamingJob.progress.processed }} processed
                        </span>
                        <span v-if="streamingJob.progress?.files_added" class="result-badge badge-success">
                            +{{ streamingJob.progress.files_added }} files
                        </span>
                        <span v-if="streamingJob.progress?.organized" class="result-badge badge-success">
                            {{ streamingJob.progress.organized }} organized
                        </span>
                        <span v-if="streamingJob.progress?.generated" class="result-badge badge-success">
                            {{ streamingJob.progress.generated }} generated
                        </span>
                    </div>
                    <div class="stream-output" ref="streamOutput">
                        <div v-for="(event, index) in streamEvents" :key="index" class="stream-event">
                            <span class="stream-timestamp">{{ formatTime(event.timestamp) }}</span>
                            <span class="stream-message">{{ event.message }}</span>
                        </div>
                        <div v-if="streamEvents.length === 0" class="stream-empty">
                            Waiting for job output...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="clearStreamEvents" class="btn-secondary btn-small">
                        Clear
                    </button>
                    <button @click="closeJobStream" class="btn-primary">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Path Help Modal -->
        <div v-if="showPathHelp" class="modal-overlay" @click="showPathHelp = false">
            <div class="modal" @click.stop style="max-width: 700px;">
                <div class="modal-header">
                    <h3>Container Path Mappings</h3>
                    <button @click="showPathHelp = false" class="btn" style="padding: 4px 12px;">√ó</button>
                </div>
                <div class="modal-body">
                    <p class="text-secondary mb-md">
                        The VAM Tools container has access to the following directories on your host system.
                        Use these paths when creating catalogs or configuring scans.
                    </p>

                    <div class="card mb-md">
                        <h4 class="mb-sm">Host Directories</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <th style="text-align: left; padding: 8px; color: var(--text-muted); font-size: 11px; text-transform: uppercase;">Host Path</th>
                                    <th style="text-align: left; padding: 8px; color: var(--text-muted); font-size: 11px; text-transform: uppercase;">Container Path</th>
                                    <th style="text-align: left; padding: 8px; color: var(--text-muted); font-size: 11px; text-transform: uppercase;">Access</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--text-primary);">/home</td>
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--accent-primary);">/host/home</td>
                                    <td style="padding: 12px 8px; font-size: 12px; color: var(--text-secondary);">Read-only</td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--text-primary);">/mnt/synology</td>
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--accent-primary);">/host/synology</td>
                                    <td style="padding: 12px 8px; font-size: 12px; color: var(--text-secondary);">Read-only</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--text-primary);">~/catalogs</td>
                                    <td style="padding: 12px 8px; font-family: monospace; font-size: 12px; color: var(--accent-primary);">/app/catalogs</td>
                                    <td style="padding: 12px 8px; font-size: 12px; color: var(--text-secondary);">Read-write</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <h4 class="mb-sm">Example Paths</h4>
                        <div style="background-color: var(--bg-primary); padding: 12px; border-radius: var(--radius-sm); font-family: monospace; font-size: 12px;">
                            <div class="mb-sm" style="color: var(--text-muted);"># Your home directory pictures</div>
                            <div class="mb-md" style="color: var(--accent-success);">/host/home/irjudson/Pictures</div>

                            <div class="mb-sm" style="color: var(--text-muted);"># Synology NAS photos directory</div>
                            <div class="mb-md" style="color: var(--accent-success);">/host/synology/photos</div>

                            <div class="mb-sm" style="color: var(--text-muted);"># Multiple directories (one per line when creating catalog)</div>
                            <div style="color: var(--accent-success);">/host/home/irjudson/Pictures</div>
                            <div style="color: var(--accent-success);">/host/synology/photos</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="showPathHelp = false" class="btn primary">Got it!</button>
                </div>
            </div>
        </div>

        <!-- Scan Confirmation Modal -->
        <div v-if="showScanConfirmModal" class="modal-overlay" @click="showScanConfirmModal = false">
            <div class="modal-content" @click.stop>
                <h3>Confirm Scan Job</h3>
                <div style="margin: 20px 0;">
                    <p style="margin-bottom: 16px;">Start scanning files for catalog: <strong>{{ currentCatalog?.name }}</strong></p>
                    <div class="form-group">
                        <label>Directories to scan:</label>
                        <ul style="list-style: none; padding-left: 0; margin-top: 8px;">
                            <li v-for="dir in currentCatalog?.source_directories"
                                :key="dir"
                                style="padding: 6px 12px; margin-bottom: 4px; background: var(--bg-secondary); border-radius: 4px; font-family: monospace; font-size: 13px;">
                                {{ dir }}
                            </li>
                        </ul>
                    </div>
                    <p style="margin-top: 16px; font-size: 14px; color: var(--text-secondary);">
                        This will scan all image and video files in the specified directories, extract metadata, and generate thumbnails.
                    </p>
                </div>
                <div class="form-actions">
                    <button type="button" @click="showScanConfirmModal = false" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="button" @click="confirmScan" class="btn-primary">
                        Start Scan
                    </button>
                </div>
            </div>
        </div>

        <!-- Find Duplicates Confirmation Modal -->
        <div v-if="showDuplicatesConfirmModal" class="modal-overlay" @click="showDuplicatesConfirmModal = false">
            <div class="modal-content" @click.stop>
                <h3>Confirm Duplicate Detection</h3>
                <div style="margin: 20px 0;">
                    <p style="margin-bottom: 16px;">Start duplicate detection for catalog: <strong>{{ currentCatalog?.name }}</strong></p>
                    <div class="form-group">
                        <label>Directories to analyze:</label>
                        <ul style="list-style: none; padding-left: 0; margin-top: 8px;">
                            <li v-for="dir in currentCatalog?.source_directories"
                                :key="dir"
                                style="padding: 6px 12px; margin-bottom: 4px; background: var(--bg-secondary); border-radius: 4px; font-family: monospace; font-size: 13px;">
                                {{ dir }}
                            </li>
                        </ul>
                    </div>
                    <p style="margin-top: 16px; font-size: 14px; color: var(--text-secondary);">
                        This will analyze all files, detect duplicates using perceptual hashing, and group similar images together.
                        This process may take some time depending on the number of files.
                    </p>
                </div>
                <div class="form-actions">
                    <button type="button" @click="showDuplicatesConfirmModal = false" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="button" @click="confirmFindDuplicates" class="btn-primary">
                        Start Duplicate Detection
                    </button>
                </div>
            </div>
        </div>

        <!-- Lightbox Viewer -->
        <div v-if="lightboxVisible" class="lightbox" @click.self="closeLightbox">
            <div class="lightbox-container">
                <!-- Main Image Area -->
                <div class="lightbox-main">
                    <!-- Navigation Buttons -->
                    <div class="lightbox-nav prev">
                        <button @click="prevImage" :disabled="lightboxImageIndex === 0" title="Previous (‚Üê)">
                            ‚Üê
                        </button>
                    </div>

                    <div class="lightbox-nav next">
                        <button @click="nextImage" :disabled="lightboxImageIndex >= images.length - 1" title="Next (‚Üí)">
                            ‚Üí
                        </button>
                    </div>

                    <!-- Close Button -->
                    <button class="lightbox-close" @click="closeLightbox" title="Close (ESC)">
                        √ó
                    </button>

                    <!-- Image -->
                    <div class="lightbox-image-wrapper">
                        <img
                            v-if="lightboxImage"
                            :src="getFullImageUrl(lightboxImage)"
                            :alt="lightboxImage.source_path"
                            class="lightbox-image"
                        />
                    </div>
                </div>

                <!-- Sidebar with Metadata -->
                <div class="lightbox-sidebar">
                    <h3 class="mb-md">Image Details</h3>

                    <!-- File Info -->
                    <div class="lightbox-metadata-section">
                        <h3>File Information</h3>
                        <div v-if="lightboxImage">
                            <div class="lightbox-metadata-item">
                                <span class="lightbox-metadata-label">Filename</span>
                                <span class="lightbox-metadata-value">
                                    {{ lightboxImage.source_path.split('/').pop() }}
                                </span>
                            </div>
                            <div class="lightbox-metadata-item">
                                <span class="lightbox-metadata-label">Path</span>
                                <span class="lightbox-metadata-value">
                                    {{ lightboxImage.source_path }}
                                </span>
                            </div>
                            <div class="lightbox-metadata-item">
                                <span class="lightbox-metadata-label">Type</span>
                                <span class="lightbox-metadata-value">
                                    {{ lightboxImage.file_type || 'Unknown' }}
                                </span>
                            </div>
                            <div class="lightbox-metadata-item">
                                <span class="lightbox-metadata-label">Size</span>
                                <span class="lightbox-metadata-value">
                                    {{ formatFileSize(lightboxImage.size_bytes) }}
                                </span>
                            </div>
                            <div class="lightbox-metadata-item">
                                <span class="lightbox-metadata-label">Checksum</span>
                                <span class="lightbox-metadata-value" style="font-family: monospace; font-size: 10px;">
                                    {{ lightboxImage.checksum ? lightboxImage.checksum.substring(0, 12) + '...' : 'N/A' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Dates -->
                    <div class="lightbox-metadata-section" v-if="lightboxImage && lightboxImage.dates">
                        <h3>Dates</h3>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.dates.created">
                            <span class="lightbox-metadata-label">Created</span>
                            <span class="lightbox-metadata-value">
                                {{ formatDate(lightboxImage.dates.created) }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.dates.modified">
                            <span class="lightbox-metadata-label">Modified</span>
                            <span class="lightbox-metadata-value">
                                {{ formatDate(lightboxImage.dates.modified) }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.dates.taken">
                            <span class="lightbox-metadata-label">Taken</span>
                            <span class="lightbox-metadata-value">
                                {{ formatDate(lightboxImage.dates.taken) }}
                            </span>
                        </div>
                    </div>

                    <!-- EXIF Metadata -->
                    <div class="lightbox-metadata-section" v-if="lightboxImage && lightboxImage.metadata">
                        <h3>EXIF Data</h3>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.camera">
                            <span class="lightbox-metadata-label">Camera</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImage.metadata.camera }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.lens">
                            <span class="lightbox-metadata-label">Lens</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImage.metadata.lens }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.iso">
                            <span class="lightbox-metadata-label">ISO</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImage.metadata.iso }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.aperture">
                            <span class="lightbox-metadata-label">Aperture</span>
                            <span class="lightbox-metadata-value">
                                f/{{ lightboxImage.metadata.aperture }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.shutter_speed">
                            <span class="lightbox-metadata-label">Shutter</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImage.metadata.shutter_speed }}
                            </span>
                        </div>
                        <div class="lightbox-metadata-item" v-if="lightboxImage.metadata.focal_length">
                            <span class="lightbox-metadata-label">Focal Length</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImage.metadata.focal_length }}mm
                            </span>
                        </div>
                    </div>

                    <!-- Navigation Info -->
                    <div class="lightbox-metadata-section">
                        <h3>Navigation</h3>
                        <div class="lightbox-metadata-item">
                            <span class="lightbox-metadata-label">Position</span>
                            <span class="lightbox-metadata-value">
                                {{ lightboxImageIndex + 1 }} of {{ images.length }}
                            </span>
                        </div>
                    </div>

                    <!-- Keyboard Shortcuts -->
                    <div class="lightbox-metadata-section">
                        <h3>Keyboard Shortcuts</h3>
                        <div class="lightbox-metadata-item">
                            <span class="lightbox-metadata-label">Previous</span>
                            <span class="lightbox-metadata-value">‚Üê Left Arrow</span>
                        </div>
                        <div class="lightbox-metadata-item">
                            <span class="lightbox-metadata-label">Next</span>
                            <span class="lightbox-metadata-value">‚Üí Right Arrow</span>
                        </div>
                        <div class="lightbox-metadata-item">
                            <span class="lightbox-metadata-label">Close</span>
                            <span class="lightbox-metadata-value">ESC</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/app.js?v=15"></script>
</body>
</html>
